<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>懂才抱．股票資訊整合系統</title>

  <meta name="description" content="客製化的股票資訊整合平台">
  <meta name="keyword" content="股票,財報狗,資訊整合平台">
  <meta name="author" content="小炫">

  <!-- 背景樣式 -->
  <link rel="stylesheet" href="css/background_integration.css">

  <!--內文css-->
  <link rel="stylesheet" href="css/content.css">
  <!-- 轉換 Markdown → HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- ★ 新增：Supabase JS SDK v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- ★ 新增：簡單 modal 樣式 -->
  <style>
    /* ★ 新增：使用次數資訊區塊 */
    #usageInfo {
      margin-top: 8px;
      font-size: 14px;
      color: #ede7f3;
    }

    /* ★ 新增：Modal 外層容器 */
    .dc-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .dc-modal.show {
      display: flex;
    }
    .dc-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
    }
    .dc-modal-content {
      position: relative;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 20px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      z-index: 1;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
    }
    .dc-modal-content h3 {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .dc-modal-content p {
      margin: 0 0 16px;
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
      white-space: pre-line;
    }
    .dc-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .dc-btn-primary {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #ffffff;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <h1>輸入股票代碼</h1>

  <input id="symbolInput" type="text" placeholder="例如：HIMS 或 NVDA" />
  <button id="fetchBtn">產生公司介紹</button>

  <!-- ★ 新增：顯示本週使用次數 / 方案 -->
  <p id="usageInfo"></p>

  <p id="debug"></p>


  <div id="result"></div>

  <!-- ★ 新增：Modal 結構 -->
  <div id="planModal" class="dc-modal">
    <div class="dc-modal-backdrop" id="planModalBackdrop"></div>
    <div class="dc-modal-content">
      <h3>已達本週使用上限</h3>
      <p id="planModalMessage"></p>
      <div class="dc-modal-actions">
        <button id="planModalClose" class="dc-btn-primary">知道了</button>
      </div>
    </div>
  </div>

  <script>
  // ============================
  // ★ 設定區
  // ============================
  // 測試時用 localhost，上線後要改成你的 Render/Railway 網址
  const BACKEND_URL = "http://localhost:3000/api/analyze-stock";

  const supabaseUrl = "https://zlkexplsleznuebighte.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsa2V4cGxzbGV6bnVlYmlnaHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MzAwNjUsImV4cCI6MjA4MTAwNjA2NX0.HPVn3jcN88M4U3-RCVW-YO-b65rDOKv6pxEaVWwbm68";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

  // 顯示用的方案限制 (僅供顯示，實際限制在後端執行)
  const PLAN_LIMIT = {
    free: 2,
    plus: 10,
    pro: Infinity
  };

  // ============================
  // ★ Modal UI 操作
  // ============================
  const planModal = document.getElementById("planModal");
  const planModalBackdrop = document.getElementById("planModalBackdrop");
  const planModalClose = document.getElementById("planModalClose");
  const planModalMessage = document.getElementById("planModalMessage");

  function showPlanModal(message) {
    planModalMessage.textContent = message;
    planModal.classList.add("show");
  }

  function hidePlanModal() {
    planModal.classList.remove("show");
  }

  planModalClose.addEventListener("click", hidePlanModal);
  planModalBackdrop.addEventListener("click", hidePlanModal);

  // ============================
  // ★ 讀取使用者資訊與方案 (僅供顯示用)
  // ============================
  async function getCurrentUserPlan() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return { user: null, plan: null };

    const { data: profile } = await supabaseClient
      .from("profiles")
      .select("plan")
      .eq("id", user.id)
      .maybeSingle();

    return { user, plan: profile?.plan || "free" };
  }

  async function getWeeklyUsage(userId) {
    const startOfWeek = new Date();
    startOfWeek.setHours(0, 0, 0, 0);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

    const { count, error } = await supabaseClient
      .from("usage_logs")
      .select("*", { count: 'exact', head: true }) // 只抓數量，比較快
      .eq("user_id", userId)
      .eq("action", "company_intro")
      .gte("created_at", startOfWeek.toISOString());

    return error ? 0 : count;
  }

  async function updateUsageInfo(user, plan) {
    const usageInfoEl = document.getElementById("usageInfo");
    if (!usageInfoEl) return;

    if (!user) {
      usageInfoEl.textContent = "請先登入以使用此功能。";
      return;
    }

    const limit = PLAN_LIMIT[plan] ?? PLAN_LIMIT["free"];
    const limitText = limit === Infinity ? "無限" : limit;
    
    // 讀取目前使用量
    const used = await getWeeklyUsage(user.id);
    usageInfoEl.textContent = `目前方案：${plan}｜本週已使用 ${used} / ${limitText} 次`;
  }

  // 頁面載入時更新一次資訊
  window.addEventListener("DOMContentLoaded", async () => {
    const { user, plan } = await getCurrentUserPlan();
    await updateUsageInfo(user, plan);
  });

  // ============================
  // ★ 主要功能：呼叫後端 API
  // ============================
  document.getElementById("fetchBtn").addEventListener("click", async () => {
    const debugEl = document.getElementById("debug");
    const resultEl = document.getElementById("result");
    const symbolInput = document.getElementById("symbolInput");
    
    // 1. 檢查輸入
    const symbol = symbolInput.value.trim().toUpperCase();
    if (!symbol) {
      alert("請輸入股票代碼！");
      return;
    }

    // 2. 檢查登入 (取得 Session Token)
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      alert("請先登入才能使用產生公司介紹功能。");
      return;
    }

    // 3. UI 狀態更新
    debugEl.textContent = "查詢中…正在分析數據...";
    resultEl.innerHTML = "<p>正在生成公司報告，請稍候...(約 15-30 秒)</p>";

    try {
      // 4. 發送請求給後端
      const response = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${session.access_token}` // ★ 關鍵：把 Token 傳給後端
        },
        body: JSON.stringify({ symbol: symbol })
      });

      const data = await response.json();

      // 5. 錯誤處理
      if (!response.ok) {
        // 如果後端回傳 403，代表額度滿了
        if (response.status === 403) {
          showPlanModal(data.error || "已達本週使用上限，請升級方案。");
          debugEl.textContent = "已達使用上限 ⛔";
          resultEl.innerHTML = "";
          return;
        }
        // 其他錯誤 (401, 500 等)
        throw new Error(data.error || "伺服器發生錯誤");
      }

      // 6. 成功：顯示結果
      // 假設後端回傳格式是 { text: "Markdown內容..." }
      const htmlContent = marked.parse(data.text);
      resultEl.innerHTML = htmlContent;
      debugEl.textContent = "查詢完成 ✔";

      // 7. 更新介面上的使用次數 (重新抓一次資料庫)
      const { user, plan } = await getCurrentUserPlan();
      await updateUsageInfo(user, plan);

    } catch (err) {
      console.error(err);
      debugEl.textContent = "❌ 錯誤：" + err.message;
      resultEl.innerHTML = `<p style='color:red'>發生錯誤，請確認後端是否已啟動。</p>`;
    }
  });
</script>
</body>
</html>
