<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ‡‚æ‰æŠ±ï¼è‚¡ç¥¨è³‡è¨Šæ•´åˆç³»çµ±</title>

  <meta name="description" content="å®¢è£½åŒ–çš„è‚¡ç¥¨è³‡è¨Šæ•´åˆå¹³å°">
  <meta name="keyword" content="è‚¡ç¥¨,è²¡å ±ç‹—,è³‡è¨Šæ•´åˆå¹³å°">
  <meta name="author" content="å°ç‚«">

  <!-- èƒŒæ™¯æ¨£å¼ -->
  <link rel="stylesheet" href="css/background_integration.css">

  <!--å…§æ–‡css-->
  <link rel="stylesheet" href="css/content.css">
  <!-- è½‰æ› Markdown â†’ HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- â˜… æ–°å¢ï¼šSupabase JS SDK v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- â˜… æ–°å¢ï¼šç°¡å–® modal æ¨£å¼ -->
  <style>
    /* â˜… æ–°å¢ï¼šä½¿ç”¨æ¬¡æ•¸è³‡è¨Šå€å¡Š */
    #usageInfo {
      margin-top: 8px;
      font-size: 14px;
      color: #ede7f3;
    }

    /* â˜… æ–°å¢ï¼šModal å¤–å±¤å®¹å™¨ */
    .dc-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .dc-modal.show {
      display: flex;
    }
    .dc-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
    }
    .dc-modal-content {
      position: relative;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 20px;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      z-index: 1;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
    }
    .dc-modal-content h3 {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .dc-modal-content p {
      margin: 0 0 16px;
      font-size: 14px;
      color: #4b5563;
      line-height: 1.6;
      white-space: pre-line;
    }
    .dc-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .dc-btn-primary {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #ffffff;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <h1>è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼</h1>

  <input id="symbolInput" type="text" placeholder="ä¾‹å¦‚ï¼šHIMS æˆ– NVDA" />
  <button id="fetchBtn">ç”¢ç”Ÿå…¬å¸ä»‹ç´¹</button>

  <!-- â˜… æ–°å¢ï¼šé¡¯ç¤ºæœ¬é€±ä½¿ç”¨æ¬¡æ•¸ / æ–¹æ¡ˆ -->
  <p id="usageInfo"></p>

  <p id="debug"></p>


  <div id="result"></div>
  <div id="chatContainer" style="display:none; margin-top: 30px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; background: rgba(255,255,255,0.05);">
  <h3 style="color: #8b5cf6;">ğŸ’¡ æ·±åº¦è¿½å• AI åˆ†æå¸«</h3>
  <div id="chatHistory" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px; font-size: 14px;"></div>
  
  <div style="display: flex; gap: 10px;">
    <input id="chatInput" type="text" placeholder="è©¢å•æ›´å¤šé—œæ–¼æ­¤å…¬å¸çš„ç´°ç¯€..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; color: #000;">
    <button id="sendChatBtn" class="dc-btn-primary">æå•</button>
  </div>
</div>

  <!-- â˜… æ–°å¢ï¼šModal çµæ§‹ -->
  <div id="planModal" class="dc-modal">
    <div class="dc-modal-backdrop" id="planModalBackdrop"></div>
    <div class="dc-modal-content">
      <h3>å·²é”æœ¬é€±ä½¿ç”¨ä¸Šé™</h3>
      <p id="planModalMessage"></p>
      <div class="dc-modal-actions">
        <button id="planModalClose" class="dc-btn-primary">çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <script>
  // ============================
  // â˜… è¨­å®šå€
  // ============================
  const BACKEND_URL = "https://dongcaibao.onrender.com/api/analyze-stock";

  const supabaseUrl = "https://zlkexplsleznuebighte.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsa2V4cGxzbGV6bnVlYmlnaHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MzAwNjUsImV4cCI6MjA4MTAwNjA2NX0.HPVn3jcN88M4U3-RCVW-YO-b65rDOKv6pxEaVWwbm68";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
  let currentSearchContext = ""; // å­˜å„²æœå°‹èƒŒæ™¯
  let currentSymbol = "";        // å­˜å„²ç•¶å‰ä»£ç¢¼
  // é¡¯ç¤ºç”¨çš„æ–¹æ¡ˆé™åˆ¶ (åƒ…ä¾›é¡¯ç¤ºï¼Œå¯¦éš›é™åˆ¶åœ¨å¾Œç«¯åŸ·è¡Œ)
  const PLAN_LIMIT = {
    free: 2,
    plus: 10,
    pro: Infinity
  };

  // ============================
  // â˜… Modal UI æ“ä½œ
  // ============================
  const planModal = document.getElementById("planModal");
  const planModalBackdrop = document.getElementById("planModalBackdrop");
  const planModalClose = document.getElementById("planModalClose");
  const planModalMessage = document.getElementById("planModalMessage");

  function showPlanModal(message) {
    planModalMessage.textContent = message;
    planModal.classList.add("show");
  }

  function hidePlanModal() {
    planModal.classList.remove("show");
  }

  planModalClose.addEventListener("click", hidePlanModal);
  planModalBackdrop.addEventListener("click", hidePlanModal);

  // ============================
  // â˜… è®€å–ä½¿ç”¨è€…è³‡è¨Šèˆ‡æ–¹æ¡ˆ (åƒ…ä¾›é¡¯ç¤ºç”¨)
  // ============================
  async function getCurrentUserPlan() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return { user: null, plan: null };

    const { data: profile } = await supabaseClient
      .from("profiles")
      .select("plan")
      .eq("id", user.id)
      .maybeSingle();

    return { user, plan: profile?.plan || "free" };
  }

  async function getWeeklyUsage(userId) {
    const startOfWeek = new Date();
    startOfWeek.setHours(0, 0, 0, 0);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

    const { count, error } = await supabaseClient
      .from("usage_logs")
      .select("*", { count: 'exact', head: true })
      .eq("user_id", userId)
      .eq("action", "company_intro")
      .gte("created_at", startOfWeek.toISOString());

    return error ? 0 : count;
  }

  async function updateUsageInfo(user, plan) {
    const usageInfoEl = document.getElementById("usageInfo");
    if (!usageInfoEl || !user) return;

    // â˜… å¿…é ˆé‡è¤‡å®šç¾©é€™ä¸€æ®µï¼Œå› ç‚ºé€™æ˜¯ä¸€å€‹æ–°çš„å‡½æ•¸æˆ¿é–“
    const startOfWeek = new Date();
    startOfWeek.setHours(0, 0, 0, 0);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

    const limit = PLAN_LIMIT[plan] ?? PLAN_LIMIT["free"];
    const limitText = limit === Infinity ? "ç„¡é™" : limit;
    
    const used = await getWeeklyUsage(user.id);

    // æŸ¥è©¢å°è©±æ¬¡æ•¸
    const { count: chatUsed } = await supabaseClient
      .from("usage_logs")
      .select("*", { count: 'exact', head: true })
      .eq("user_id", user.id)
      .eq("action", "chat_query")
      .gte("created_at", startOfWeek.toISOString()); // å¦‚æœä¸Šé¢æ²’å®šç¾©ï¼Œç¨‹å¼æœƒæ­»åœ¨é€™è£¡

    const chatLimit = (plan === 'pro') ? "ç„¡é™" : (plan === 'plus' ? 20 : 5);
    
    usageInfoEl.innerHTML = `
      ç›®å‰æ–¹æ¡ˆï¼š<span class="plan-tag plan-${plan}">${plan}</span> 
      ï½œ æœ¬é€±å ±å‘Šï¼š${used} / ${limitText} æ¬¡
      <br>ğŸ’¬ æœ¬é€±å°è©±ï¼š${chatUsed || 0} / ${chatLimit} æ¬¡
    `;
  }

  // é é¢è¼‰å…¥æ™‚æ›´æ–°ä¸€æ¬¡è³‡è¨Š
  window.addEventListener("DOMContentLoaded", async () => {
    const { user, plan } = await getCurrentUserPlan();
    await updateUsageInfo(user, plan);
  });

  // ============================
  // â˜… ä¸»è¦åŠŸèƒ½ï¼šå‘¼å«å¾Œç«¯ API
  // ============================
  document.getElementById("fetchBtn").addEventListener("click", async () => {
    const debugEl = document.getElementById("debug");
    const resultEl = document.getElementById("result");
    const symbolInput = document.getElementById("symbolInput");
    
    // 1. æª¢æŸ¥è¼¸å…¥
    const symbol = symbolInput.value.trim().toUpperCase();
    if (!symbol) {
      alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼");
      return;
    }

    // 2. æª¢æŸ¥ç™»å…¥ (å–å¾— Session Token)
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) {
      alert("è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨ç”¢ç”Ÿå…¬å¸ä»‹ç´¹åŠŸèƒ½ã€‚");
      return;
    }

    // 3. UI ç‹€æ…‹æ›´æ–°
    debugEl.textContent = "æŸ¥è©¢ä¸­â€¦æ­£åœ¨åˆ†ææ•¸æ“š...";
    resultEl.innerHTML = "<p>æ­£åœ¨ç”Ÿæˆå…¬å¸å ±å‘Šï¼Œè«‹ç¨å€™...(ç´„ 15-30 ç§’)</p>";

    try {
      // 4. ç™¼é€è«‹æ±‚çµ¦å¾Œç«¯
      const response = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${session.access_token}` // â˜… é—œéµï¼šæŠŠ Token å‚³çµ¦å¾Œç«¯
        },
        body: JSON.stringify({ symbol: symbol })
      });

      const data = await response.json();

      // 5. éŒ¯èª¤è™•ç†
      if (!response.ok) {
        // å¦‚æœå¾Œç«¯å›å‚³ 403ï¼Œä»£è¡¨é¡åº¦æ»¿äº†
        if (response.status === 403) {
          showPlanModal(data.error || "å·²é”æœ¬é€±ä½¿ç”¨ä¸Šé™ï¼Œè«‹å‡ç´šæ–¹æ¡ˆã€‚");
          debugEl.textContent = "å·²é”ä½¿ç”¨ä¸Šé™ â›”";
          resultEl.innerHTML = "";
          return;
        }
        // å…¶ä»–éŒ¯èª¤ (401, 500 ç­‰)
        throw new Error(data.error || "ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤");
      }
      

      // --- â˜… ä¿®æ”¹é–‹å§‹ï¼šåˆ¤æ–·æ–¹æ¡ˆä¸¦å¥—ç”¨æ¨£å¼ ---
      const resultEl = document.getElementById("result");

      if (data.plan === 'pro') {
          resultEl.classList.add("pro-report-style"); // å¥—ç”¨é‡‘è‰²æ¨£å¼
      } else {
          resultEl.classList.remove("pro-report-style"); // ç§»é™¤æ¨£å¼ (é¿å…ä¸Šæ¬¡æŸ¥è©¢æ®˜ç•™)
      }

      // æ¸²æŸ“çµæœ
      const htmlContent = marked.parse(data.text);
      resultEl.innerHTML = htmlContent;
      // â˜… æ–°å¢ï¼šå­˜ä¸‹æœå°‹èƒŒæ™¯èˆ‡ä»£ç¢¼ï¼Œä¸¦é¡¯ç¤ºå°è©±æ¡†
      currentSearchContext = data.searchContext; 
      currentSymbol = symbol;
      document.getElementById("chatContainer").style.display = "block";
      document.getElementById("chatHistory").innerHTML = ""; // æ¸…ç©ºä¸Šæ¬¡å°è©±
      // --- â˜… ä¿®æ”¹çµæŸ ---

      debugEl.textContent = "æŸ¥è©¢å®Œæˆ âœ”";

      // 7. æ›´æ–°ä»‹é¢ä¸Šçš„ä½¿ç”¨æ¬¡æ•¸ (é‡æ–°æŠ“ä¸€æ¬¡è³‡æ–™åº«)
      const { user, plan } = await getCurrentUserPlan();
      await updateUsageInfo(user, plan);

    } catch (err) {
      console.error(err);
      debugEl.textContent = "âŒ éŒ¯èª¤ï¼š" + err.message;
      resultEl.innerHTML = `<p style='color:red'>ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªå¾Œç«¯æ˜¯å¦å·²å•Ÿå‹•ã€‚</p>`;
    }
  });
  // ============================
  // â˜… æ–°å¢ï¼šAI å°è©±æå•åŠŸèƒ½
  // ============================
  document.getElementById("sendChatBtn").addEventListener("click", async () => {
    const chatInput = document.getElementById("chatInput");
    const chatHistory = document.getElementById("chatHistory");
    const userQuery = chatInput.value.trim();

    if (!userQuery) return;

    // 1. åœ¨ä»‹é¢ä¸Šé¡¯ç¤ºä½¿ç”¨è€…çš„å•é¡Œ
    chatHistory.innerHTML += `<div style="margin-bottom:10px; color:#fff;"><strong>ğŸ‘¤ æ‚¨ï¼š</strong>${userQuery}</div>`;
    chatInput.value = "";

    // 2. é¡¯ç¤ºæ€è€ƒä¸­ç‹€æ…‹
    const loadingId = "loading-" + Date.now();
    chatHistory.innerHTML += `<div id="${loadingId}" style="margin-bottom:10px; color:#a78bfa;">AI åˆ†æå¸«æ­£åœ¨æ€è€ƒä¸­...</div>`;
    chatHistory.scrollTop = chatHistory.scrollHeight;

    try {
      const { data: { session } } = await supabaseClient.auth.getSession();
      
      // 3. å‘¼å«å¾Œç«¯å°è©± API
      const response = await fetch("https://dongcaibao.onrender.com/api/chat-with-report", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify({
          symbol: currentSymbol,
          searchContext: currentSearchContext,
          userQuery: userQuery
        })
      });

      const data = await response.json();
      if (!response.ok) throw new Error(data.error || "å°è©±å¤±æ•—");

      // 4. ç§»é™¤ loading ä¸¦é¡¯ç¤º AI å›ç­”
      document.getElementById(loadingId).remove();
      chatHistory.innerHTML += `
        <div style="margin-bottom:20px; padding-left:10px; border-left:3px solid #8b5cf6; color:#ede7f3;">
          <strong>ğŸ¤– AIï¼š</strong><br>${marked.parse(data.text)}
        </div>
      `;
      chatHistory.scrollTop = chatHistory.scrollHeight;

    } catch (err) {
      console.error(err);
      document.getElementById(loadingId).innerHTML = `<span style="color:red;">âŒ éŒ¯èª¤ï¼š${err.message}</span>`;
    }
  });
</script>
</body>
</html>
