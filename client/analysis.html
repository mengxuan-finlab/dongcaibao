<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‡‚æ‰æŠ±ï½œè²¡å ±å¿«ç…§</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="css/analysis.css" />
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title" id="title">è¼‰å…¥ä¸­...</h1>
        <div class="subtitle" id="subTitle">æ‡‚æ‰æŠ± Â· è²¡å ±å¿«ç…§ï¼ˆSnapshotï¼‰</div>
        <div class="subtitle" id="planBadge" style="opacity:.85; font-size:13px; margin-top:6px;">
          æ–¹æ¡ˆï¼šè¼‰å…¥ä¸­â€¦
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="core_screener.html">â† å›é¸è‚¡å™¨</a>
        <a class="btn" id="tvLink" href="#" target="_blank" rel="noopener">TradingView</a>
        <a class="btn" id="yfLink" href="#" target="_blank" rel="noopener">Yahoo</a>
      </div>
    </div>

    <div id="snapshot" class="state">æ­£åœ¨è¼‰å…¥è³‡æ–™â€¦</div>
    <div id="trends" style="margin-top:16px;"></div>
    <div id="health" style="margin-top:16px;"></div>
  </div>

<script>

// === Auth/Portfolio Supabaseï¼ˆç”¨ä¾†è®€ç™»å…¥èˆ‡æ–¹æ¡ˆï¼‰===
const SB_AUTH_URL = "https://zlkexplsleznuebighte.supabase.co";
const SB_AUTH_ANON = "sb_publishable_KvJtQN9R6YC5PpsKLFtu0Q_43LqiQN-";
const sbAuth = window.supabase.createClient(SB_AUTH_URL, SB_AUTH_ANON);

// === Stock Data Supabaseï¼ˆç”¨ä¾†è®€è‚¡ç¥¨è³‡æ–™ï¼‰===
const SB_DATA_URL = "https://ojeirmqxborwxhuwuems.supabase.co";
const SB_DATA_ANON = "sb_publishable_wur9F2qRW0NFyZpijPub2A__IsGlpgZ";
const sbData = window.supabase.createClient(SB_DATA_URL, SB_DATA_ANON);


const params = new URLSearchParams(window.location.search);
const symbol = (params.get("symbol") || "").toUpperCase();

// ============================
// Plan / Permission
// ============================
let __plan = "free";   // free | plus | pro
let __isPro = false;
let __user = null;

async function getCurrentUserPlan() {
  const { data: sessionData } = await sbAuth.auth.getSession();
  const session = sessionData?.session;

  if (!session?.user) return { user: null, plan: "free" };

  const user = session.user;

  const { data: profile, error } = await sbAuth
    .from("profiles")
    .select("plan")
    .eq("id", user.id)
    .maybeSingle();

  // å¦‚æœ RLS æˆ–è³‡æ–™ç¼ºå¤±ï¼Œè‡³å°‘ä¸è¦ç‚¸æ‰
  const plan = (!error && profile?.plan) ? profile.plan : "free";
  return { user, plan };
}



function setPlanUI(plan){
  const el = document.getElementById("planBadge");
  if (!el) return;

  const text =
    plan === "pro"  ? "æ–¹æ¡ˆï¼šProï¼ˆå·²è§£é–é€²éšï¼‰" :
    plan === "plus" ? "æ–¹æ¡ˆï¼šPlus" :
                      "æ–¹æ¡ˆï¼šFree";

  el.textContent = text;
}

// é€™å€‹å‡½å¼æ˜¯ã€Œæœªä¾†æ–°å¢ Pro æŒ‡æ¨™ã€æ™‚çš„å…¥å£ï¼šåªå…è¨± Pro å‘¼å«
function requireProOrShowCard() {
  if (__isPro) return true;

  const host = document.getElementById("trends");
  if (host && !document.getElementById("proOnlyCard")) {
    host.insertAdjacentHTML("beforeend", `
      <div id="proOnlyCard" class="card" style="margin-top:14px;">
        <div class="cardHeader">
          <h3 class="cardTitle">é«˜è³‡ç”¢æ¨¡å¼ï¼ˆPro é™å®šï¼‰</h3>
          <span class="pill">Pro Only</span>
        </div>
        <div class="note">
          é€²éšæŒ‡æ¨™ï¼ˆå¦‚ï¼šæ¯›åˆ©ç‡/ç‡Ÿç›Šç‡è¶¨å‹¢ã€ROIC è¶¨å‹¢ã€è³‡æœ¬çµæ§‹ã€è‚¡æœ¬ç¨€é‡‹ï¼‰åƒ…é™ Pro æ–¹æ¡ˆä½¿ç”¨ã€‚
        </div>
        <div class="note">
          è‹¥è¦è§£é–ï¼Œè«‹å‡ç´šè‡³ Pro æ–¹æ¡ˆã€‚
        </div>
      </div>
    `);
  }
  return false;
}

async function getAccessToken() {
  const { data } = await sbAuth.auth.getSession();
  return data?.session?.access_token || null;
}

function fmtPct100(x, digits=1){
  if (x == null || Number.isNaN(Number(x))) return "â€”";
  return (Number(x)*100).toFixed(digits) + "%";
}
function fmtNum2(x, digits=2){
  if (x == null || Number.isNaN(Number(x))) return "â€”";
  return Number(x).toFixed(digits);
}

async function loadProMetrics(sym){
  const token = await getAccessToken();
  if (!token) throw new Error("æœªç™»å…¥");

  // ä½ çš„ Node server ä½å€ï¼ˆæœ¬æ©Ÿé–‹ç™¼ï¼‰
  const apiBase = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
  ? "http://localhost:3000"
  : "https://dongcaibao.onrender.com"; 

  const res = await fetch(`${apiBase}/api/pro-metrics?symbol=${encodeURIComponent(sym)}`, {
    method: "GET",
    headers: { "Authorization": `Bearer ${token}` }
  });

  const json = await res.json();
  if (!res.ok) throw new Error(json?.error || `HTTP ${res.status}`);
  return json;
}

// ä¿®æ­£å¾Œçš„è®Šæ•¸å°æ‡‰ï¼ˆå‡è¨­å¾Œç«¯å›å‚³çš„æ˜¯æ‰å¹³çš„æ¬„ä½åç¨±ï¼‰
// å‰ç«¯åˆ†æé é¢ (analysis.html)
function renderProCard(p) {
  const host = document.getElementById("trends");
  if (!host || !p.snapshot || !p.history) return;

  const s = p.snapshot;
  const h = p.history; 

  // --- 1. å¼·åŒ–ç‰ˆè©•åƒ¹é‚è¼¯ ---
  
  // A. PE å‡å€¼èˆ‡è­¦ç¤º
  const peList = h.map(item => item.pe).filter(v => v > 0);
  const avgPe = peList.length > 0 ? peList.reduce((a, b) => a + b, 0) / peList.length : 0;
  const isPeCheap = s.pe > 0 && s.pe < avgPe;
  // è­¦ç¤ºï¼šPE é«˜æ–¼å‡å€¼ 20% OR PE çµ•å°å€¼éé«˜ (> 60)
  const isPeWarning = s.pe > (avgPe * 1.2) || s.pe > 60;

  // B. P/FCF å‡å€¼èˆ‡è­¦ç¤º (é‡å° LLY é€™ç¨®ç¾é‡‘æµç•°å¸¸çš„æƒ…æ³)
  const fcfList = h.map(item => item.p_fcf).filter(v => v > 0);
  const avgFcf = fcfList.length > 0 ? fcfList.reduce((a, b) => a + b, 0) / fcfList.length : 0;
  const fcfEval = s.p_fcf > avgFcf ? "ï¼ˆé«˜æ–¼æ­·å²å‡å€¼ï¼‰" : "ï¼ˆå…·å‚™å®‰å…¨é‚Šéš›ï¼‰";
  // è­¦ç¤ºï¼šP/FCF é«˜æ–¼å‡å€¼ 20% OR P/FCF çµ•å°å€¼æ¥µç«¯ (> 80)
  const isFcfWarning = s.p_fcf > (avgFcf * 1.2) || s.p_fcf > 80;

  // C. ROIC æ•ˆç‡è©•åƒ¹
  const roicEval = s.roic > 0.4 ? "ï¼ˆè³‡æœ¬æ•ˆç‡æ¥µé«˜ï¼‰" : s.roic > 0.15 ? "ï¼ˆç²åˆ©å“è³ªå„ªï¼‰" : "ï¼ˆæ•ˆç‡å¾…è§€å¯Ÿï¼‰";

  // D. FCF Margin (ç¾é‡‘å«é‡‘é‡)
  const fcfMargin = s.fcfMargin || 0;
  const fcfMarginEval = fcfMargin > 0.25 ? "ï¼ˆç¾é‡‘è½‰åŒ–æ¥µå¼·ï¼‰" : 
                        fcfMargin > 0.15 ? "ï¼ˆç¾é‡‘è½‰åŒ–å„ªè‰¯ï¼‰" : 
                        fcfMargin > 0 ? "ï¼ˆç¾é‡‘æµç©©å®šï¼‰" : "ï¼ˆéœ€æ³¨æ„ç¾é‡‘ç¼ºå£ï¼‰";

  // --- 2. æ’å…¥ HTML çµæ§‹ ---
  host.insertAdjacentHTML("beforeend", `
      <div class="card" style="margin-top:16px; border:2px solid #ffd700; background: rgba(255, 215, 0, 0.05);">
        <div class="cardHeader">
          <h3 class="cardTitle" style="color:#ffd700;">ğŸ’ Pro é€²éšåˆ†æï¼šè­·åŸæ²³èˆ‡ä¼°å€¼å®‰å…¨é‚Šéš›</h3>
          <span class="pill" style="background:#ffd700; color:#000;">Pro Only</span>
        </div>

        <div style="margin: 12px 0; display: flex; gap: 8px; flex-wrap: wrap;">
          ${s.roic > 0.15 ? 
            `<span class="hpill good item-help" data-tip="è¤‡åˆ©æ©Ÿå™¨ï¼šROIC > 15%ï¼Œå…·å‚™æ ¸å¿ƒè­·åŸæ²³ã€‚">è¤‡åˆ©æ©Ÿå™¨ âœ…</span>` : 
            (s.roic < 0.05 && s.roic !== null ? `<span class="hpill bad item-help" data-tip="æ•ˆç‡å ªæ†‚ï¼šROIC < 5%ï¼Œè³‡é‡‘å›å ±éä½ã€‚">æ•ˆç‡å ªæ†‚ âš ï¸</span>` : '')
          }
            
          ${s.net_debt_to_ebitda < 1 ? 
            `<span class="hpill good item-help" data-tip="è²¡å‹™å ¡å£˜ï¼šæ·¨è² å‚µæ¯” < 1ï¼Œè²¡å‹™æ¥µåº¦å¥å£¯ã€‚">è²¡å‹™å ¡å£˜ âœ…</span>` : 
            (s.net_debt_to_ebitda > 3 ? `<span class="hpill bad item-help" data-tip="è² å‚µæ²‰é‡ï¼šæ·¨è² å‚µæ¯” > 3ï¼Œæ³¨æ„åˆ©æ¯å£“åŠ›ã€‚">è² å‚µè­¦è¨Š âš ï¸</span>` : '')
          }
            
          ${isPeCheap ? 
            `<span class="hpill good item-help" data-tip="ç›®å‰ PE ä½æ–¼ 5 å¹´å‡å€¼ï¼Œå…·å‚™å®‰å…¨é‚Šéš›ã€‚">ä¼°å€¼ä¾¿å®œ âœ…</span>` : 
            (isPeWarning || isFcfWarning ? `<span class="hpill bad item-help" data-tip="ä¼°å€¼åé«˜ï¼šPE æˆ– P/FCF é¡¯è‘—é«˜æ–¼æ­·å²å‡å€¼ï¼Œè¿½é«˜é¢¨éšªå¤§ã€‚">ä¼°å€¼åé«˜ âš ï¸</span>` : '')
          }
        </div>

        <div class="chartGrid">
          <div class="chartBox"><div class="chartTitle">ç²åˆ©æ•ˆç‡è¶¨å‹¢ (æ¯›åˆ© vs ç‡Ÿç›Š %)</div><div class="chartCanvasWrap"><canvas id="proMarginChart"></canvas></div></div>
          <div class="chartBox"><div class="chartTitle">ROIC è³‡æœ¬å›å ±è¶¨å‹¢ (%)</div><div class="chartCanvasWrap"><canvas id="proRoicChart"></canvas></div></div>
          <div class="chartBox"><div class="chartTitle">ä¼°å€¼æ°´ä½è¶¨å‹¢ (PE vs P/FCF)</div><div class="chartCanvasWrap"><canvas id="proValuationChart"></canvas></div></div>
        </div>
        
        <div class="pro-snapshot-footer" style="margin-top: 20px; padding: 16px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border-left: 4px solid #ffd700;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div style="font-size: 16px; font-weight: 600; color: #ffd700;">ğŸ“Œ æœ€æ–°å¿«ç…§æ•¸æ“š (Latest Snapshot)</div>
            <div style="display: flex; gap: 24px; flex-wrap: wrap; font-size: 15px; color: #eee;">
              <div>ROIC: <b style="color:#fff; font-size:20px;">${fmtPct(s.roic, 1)}</b><span style="color:#ffd700; font-size:13px; margin-left:4px;">${roicEval}</span></div>
              <div>FCF Margin: <b style="color:#fff; font-size:20px;">${fmtPct(fcfMargin, 1)}</b><span style="color:#ffd700; font-size:13px; margin-left:4px;">${fcfMarginEval}</span></div>
              <div>P/FCF: <b style="color:#fff; font-size:20px;">${fmtNum(s.p_fcf, 1)}</b><span style="opacity:0.8; font-size:13px; margin-left:4px;">${fcfEval}</span></div>
            </div>
          </div>
        </div>
      </div>
  `);

  // --- 3. å‘¼å« Chart.js æ¸²æŸ“åœ–è¡¨ ---
  const labels = h.map(item => item.year);
  
  // åœ–è¡¨ Aï¼šç²åˆ©ç‡è¶¨å‹¢
  new Chart(document.getElementById('proMarginChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'æ¯›åˆ©ç‡', data: h.map(i => (i.grossMargin * 100).toFixed(1)), borderColor: '#ffd700', tension: 0.3 },
        { label: 'ç‡Ÿç›Šç‡', data: h.map(i => (i.operatingMargin * 100).toFixed(1)), borderColor: '#4bc0c0', tension: 0.3 }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // åœ–è¡¨ Bï¼šROIC è¶¨å‹¢
  new Chart(document.getElementById('proRoicChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'ROIC',
        data: h.map(i => (i.roic * 100).toFixed(1)),
        borderColor: '#ff6384',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // åœ–è¡¨ Cï¼šä¼°å€¼è¶¨å‹¢ (PE vs P/FCF)
  new Chart(document.getElementById('proValuationChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'PE', data: h.map(i => i.pe.toFixed(1)), borderColor: '#ffd700', tension: 0.3 },
        { label: 'P/FCF', data: h.map(i => i.p_fcf.toFixed(1)), borderColor: '#ff6384', tension: 0.3 }
      ]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { color: '#ccc', font: { size: 10 } } }
      }
    }
  });
}
// ===== FMP (Income / Cash Flow) =====
const FMP_API_KEY = "PHTJpjhhPVzIdzjMEP84WKq5JiNRYxA6";
let _revChart = null;
let _epsChart = null;
let _fcfChart = null;

// --- åœ¨é€™è£¡åŠ å…¥æŒ‡æ¨™å®šç¾© ---
const METRIC_DEFINITIONS = {
  "ç‡Ÿæ”¶æˆé•· â‰¥ 10%": "åæ˜ å…¬å¸æ¥­å‹™æ“´å¼µé€Ÿåº¦ï¼Œå…©ä½æ•¸æˆé•·é€šå¸¸è¢«è¦–ç‚ºæˆé•·è‚¡çš„é–€æª»ã€‚",
  "EPS æˆé•· â‰¥ 10%": "ç´”ç›Šæˆé•·ç‡ï¼Œç¢ºä¿å…¬å¸ä¸åªæ˜¯ç‡Ÿæ”¶å¢åŠ ï¼Œç²åˆ©èƒ½åŠ›ä¹ŸåŒæ­¥æå‡ã€‚",
  "FCF æˆé•· > 0%": "è‡ªç”±ç¾é‡‘æµæˆé•·ï¼Œä»£è¡¨å…¬å¸æœ‰æ›´å¤šçœŸé‡‘ç™½éŠ€å¯ç”¨æ–¼æŠ•è³‡æˆ–ç™¼è‚¡æ¯ã€‚",
  "PEG â‰¤ 2.0": "æœ¬ç›Šæˆé•·æ¯”ã€‚å°‡ä¼°å€¼èˆ‡æˆé•·æ€§çµåˆï¼Œæ•¸å€¼è¶Šä½ä»£è¡¨æˆé•·æˆæœ¬è¶Šä¾¿å®œã€‚",
  "ç¾é‡‘æ®–åˆ©ç‡ â‰¥ 4%": "æŠ•è³‡äººæ¯å¹´å¯ç²å¾—çš„ç¾é‡‘åˆ†ç´…ä½”è‚¡åƒ¹çš„æ¯”ç‡ã€‚",
  "é…æ¯ç‡ â‰¤ 90%": "ç›ˆé¤˜ç™¼æ”¾æˆè‚¡åˆ©çš„æ¯”ä¾‹ï¼Œéé«˜(>100%)å¯èƒ½ä»£è¡¨åœ¨åƒè€æœ¬ã€‚",
  "è‚¡æ¯æˆé•· > 0": "å…¬å¸æ˜¯å¦æœ‰èƒ½åŠ›ä¸”é¡˜æ„é€å¹´å¢åŠ ç™¼æ”¾çš„è‚¡æ¯ã€‚",
  "ä½æ³¢å‹• (Î² < 1)": "è²å¡”ä¿‚æ•¸ï¼Œå°æ–¼1ä»£è¡¨è‚¡åƒ¹æ³¢å‹•æ¯”å¤§ç›¤ç©©å®šã€‚",
  "PE â‰¤ 15": "æœ¬ç›Šæ¯”ã€‚ä»£è¡¨å›æœ¬å¹´æ•¸ï¼Œåƒ¹å€¼å‹æŠ•è³‡é€šå¸¸è¿½æ±‚è¼ƒä½çš„å€æ•¸ã€‚",
  "EV/EBITDA â‰¤ 12": "ä¼æ¥­åƒ¹å€¼å€æ•¸ã€‚æ¯” PE æ›´èƒ½æ’é™¤æœƒè¨ˆæŠ˜èˆŠå½±éŸ¿ï¼Œè¡¡é‡ç‡Ÿé‹ç¾é‡‘æµä¼°å€¼ã€‚",
  "P/FCF â‰¤ 20": "è‚¡åƒ¹ç›¸å°æ–¼è‡ªç”±ç¾é‡‘æµçš„å€æ•¸ï¼Œè¡¡é‡æ¯è‚¡è³ºå–å¯¦è³ªç¾é‡‘çš„èƒ½åŠ›ã€‚",
  "PB â‰¤ 1.5": "è‚¡åƒ¹æ·¨å€¼æ¯”ã€‚è¡¡é‡è‚¡åƒ¹æ˜¯å¦æ¥è¿‘å…¶æ¸…ç®—åƒ¹å€¼ã€‚",
  "æµå‹•æ¯” â‰¥ 1": "çŸ­æœŸè³‡ç”¢æ˜¯å¦è¶³ä»¥æ”¯ä»˜çŸ­æœŸè² å‚µï¼Œè¡¡é‡çŸ­æœŸç ´ç”¢é¢¨éšªã€‚",
  "æ·¨è² å‚µ/EBITDA â‰¤ 4": "è¡¡é‡å…¬å¸é æœ¬æ¥­ç²åˆ©é‚„æ¸…æ‰€æœ‰å‚µå‹™éœ€è¦å¹¾å¹´ã€‚",
  "è² å‚µæ¬Šç›Šæ¯” â‰¤ 2": "è¡¡é‡å…¬å¸è²¡å‹™æ§“æ¡¿é«˜ä½ï¼Œæ¯”ä¾‹éé«˜ä»£è¡¨å€ŸéŒ¢éå¤šã€‚",
  "ROE > 0": "è‚¡æ±æ¬Šç›Šå ±é…¬ç‡ã€‚æœ€åŸºæœ¬çš„ç²åˆ©è¦æ±‚ï¼Œä»£è¡¨å…¬å¸æ²’åœ¨è™§éŒ¢ã€‚"
};
async function fetchIncomeStatementFY(sym) {
  const url = `https://financialmodelingprep.com/stable/income-statement?symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(FMP_API_KEY)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`FMP income HTTP ${res.status}`);
  const json = await res.json();
  if (!Array.isArray(json)) return [];

  return json
    .filter(r => (String(r.period || "").toUpperCase() === "FY") || (r.calendarYear && !r.period))
    .map(r => ({
      year: Number(r.fiscalYear || r.calendarYear || (r.date ? String(r.date).slice(0,4) : NaN)),
      revenue: Number(r.revenue),
      eps: Number((r.eps ?? r.epsDiluted)),
    }))
    .filter(r => Number.isFinite(r.year))
    .sort((a,b) => a.year - b.year);
}

async function fetchCashFlowFY(sym) {
  const url = `https://financialmodelingprep.com/stable/cash-flow-statement?symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(FMP_API_KEY)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`FMP cashflow HTTP ${res.status}`);
  const json = await res.json();
  if (!Array.isArray(json)) return [];

  return json
    .filter(r => String(r.period || "").toUpperCase() === "FY")
    .map(r => ({
      year: Number(r.fiscalYear || (r.date ? String(r.date).slice(0,4) : NaN)),
      fcf: Number(r.freeCashFlow),
    }))
    .filter(r => Number.isFinite(r.year))
    .sort((a,b) => a.year - b.year);
}

function destroyCharts(){
  if (_revChart) { _revChart.destroy(); _revChart = null; }
  if (_epsChart) { _epsChart.destroy(); _epsChart = null; }
  if (_fcfChart) { _fcfChart.destroy(); _fcfChart = null; }
}

function renderLineChart(canvas, labels, series, title, ySuffix="", decimals=1){
  const ctx = canvas.getContext("2d");
  return new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: title,
        data: series,
        tension: 0.25,
        pointRadius: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (c) => `${Number(c.parsed.y).toFixed(decimals)}${ySuffix}`
          }
        }
      },
      scales: {
        x: { ticks: { maxRotation: 0 } },
        y: {
          ticks: {
            callback: (v) => Number(v).toFixed(decimals) // å·¦é‚Šåˆ»åº¦å°æ•¸ä½
          }
        }
      }
    }
  });
}

async function loadQuickTrends(sym){
  const el = document.getElementById("trends");
  if (!el) return;

  el.innerHTML = `
    <div class="card">
      <div class="cardHeader">
        <h3 class="cardTitle">è²¡å‹™è¶¨å‹¢ï¼ˆQuick Trendsï¼‰</h3>
        <span class="pill">FMP Â· Income & Cash Flow</span>
      </div>

      <div id="trendState" class="note">è¼‰å…¥ä¸­â€¦</div>

      <div class="chartGrid">
        <div class="chartBox">
          <div class="chartTitle">ç‡Ÿæ”¶ï¼ˆå„„ USDï¼‰</div>
          <div class="chartCanvasWrap"><canvas id="revChart"></canvas></div>
        </div>

        <div class="chartBox">
          <div class="chartTitle">EPSï¼ˆUSDï¼‰</div>
          <div class="chartCanvasWrap"><canvas id="epsChart"></canvas></div>
        </div>

        <div class="chartBox">
          <div class="chartTitle">è‡ªç”±ç¾é‡‘æµ FCFï¼ˆå„„ USDï¼‰</div>
          <div class="chartCanvasWrap"><canvas id="fcfChart"></canvas></div>
        </div>
      </div>

      <div class="note">è³‡æ–™ä¾†æºï¼šFinancial Modeling Prepï¼ˆå¹´åº¦ FYï¼‰ã€‚</div>
    </div>
  `;

  try{
    destroyCharts();

    const [fy, fcfFY] = await Promise.all([
      fetchIncomeStatementFY(sym),
      fetchCashFlowFY(sym),
    ]);

    const state = document.getElementById("trendState");

    if (!fy.length){
      state.textContent = "æš«æ™‚æŠ“ä¸åˆ°è¶¨å‹¢è³‡æ–™ï¼ˆå¯èƒ½ API ç„¡è³‡æ–™æˆ–è¢«é™åˆ¶ï¼‰ã€‚";
      return;
    }

    const last = fy.slice(-8);
    const labels = last.map(x => String(x.year));
    const revenueB = last.map(x => Number.isFinite(x.revenue) ? +(x.revenue / 1e9).toFixed(1) : null);
    const eps = last.map(x => Number.isFinite(x.eps) ? +x.eps.toFixed(2) : null);

    const fcfMap = new Map((fcfFY || []).map(r => [r.year, r.fcf]));
    const fcfB = last.map(x => {
      const v = fcfMap.get(x.year);
      return Number.isFinite(v) ? +(v / 1e9).toFixed(1) : null;
    });

    state.textContent = "";

    _revChart = renderLineChart(document.getElementById("revChart"), labels, revenueB, "Revenue", " å„„", 1);
    _epsChart = renderLineChart(document.getElementById("epsChart"), labels, eps, "EPS", "", 2);
    _fcfChart = renderLineChart(document.getElementById("fcfChart"), labels, fcfB, "Free Cash Flow", " å„„", 1);

  } catch(e){
    const state = document.getElementById("trendState");
    if (state) state.textContent = `è¶¨å‹¢è¼‰å…¥å¤±æ•—ï¼š${e.message}`;
  }
}

// --------- formatting ----------
function fmtPct(x, digits=1){
  if (x == null || Number.isNaN(x)) return "â€”";
  return (x*100).toFixed(digits) + "%";
}
function fmtNum(x, digits=1){
  if (x == null || Number.isNaN(x)) return "â€”";
  return Number(x).toFixed(digits);
}
function fmtCap(x){
  if (x == null || Number.isNaN(x)) return "â€”";
  const n = Number(x);
  if (n >= 1e12) return (n/1e12).toFixed(2) + " å…†";
  if (n >= 1e9)  return (n/1e9).toFixed(1) + " å„„";
  if (n >= 1e6)  return (n/1e6).toFixed(1) + " ç™¾è¬";
  return n.toLocaleString();
}
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

// --------- scoring ----------
function calculateScore(d) {
  let quality = 0, growth = 0, valuation = 0;

  // å“è³ªï¼ˆ40ï¼‰
  if (d.roe >= 0.2) quality += 15;
  else if (d.roe >= 0.1) quality += 10;
  else quality += 5;

  if (d.roic >= 0.15) quality += 15;
  else if (d.roic >= 0.08) quality += 10;
  else quality += 5;

  if (d.fcf_yield >= 0.04) quality += 10;
  else if (d.fcf_yield >= 0.02) quality += 5;

  // æˆé•·ï¼ˆ30ï¼‰
  if (d.revenue_growth >= 0.15) growth += 15;
  else if (d.revenue_growth >= 0.05) growth += 10;
  else growth += 5;

  if (d.eps_growth >= 0.15) growth += 15;
  else if (d.eps_growth >= 0.05) growth += 10;
  else growth += 5;

  // ä¼°å€¼ï¼ˆ30ï¼‰
  if (d.pe != null && d.pe <= 20) valuation += 15;
  else if (d.pe != null && d.pe <= 30) valuation += 10;
  else valuation += 5;

  if (d.fcf_yield >= 0.04) valuation += 15;
  else if (d.fcf_yield >= 0.02) valuation += 10;
  else valuation += 5;

  const total = quality + growth + valuation;

  let grade = "æ™®é€š";
  if (total >= 80) grade = "å„ªè³ª";
  else if (total >= 65) grade = "è‰¯å¥½";

  let ringColor = getComputedStyle(document.documentElement).getPropertyValue('--mid').trim();
  if (total >= 80) ringColor = getComputedStyle(document.documentElement).getPropertyValue('--good').trim();
  else if (total < 65) ringColor = getComputedStyle(document.documentElement).getPropertyValue('--bad').trim();

  return { total, quality, growth, valuation, grade, ringColor };
}

function buildInsight(d, s) {
  const lines = [];

  const rev = d.revenue_growth;
  const eps = d.eps_growth;
  if (rev == null || eps == null) {
    lines.push("æˆé•·ï¼šéƒ¨åˆ†æˆé•·æŒ‡æ¨™ç¼ºå€¼ï¼Œå»ºè­°å†ç¢ºèªç‡Ÿæ”¶èˆ‡ EPS çš„æœ€æ–°è¶¨å‹¢ã€‚");
  } else if (rev >= 0.15 && eps >= 0.15) {
    lines.push("æˆé•·ï¼šç‡Ÿæ”¶èˆ‡ EPS çš†ç¶­æŒé«˜é€Ÿæˆé•·ï¼Œæ”¯æ’æˆé•·è©•åˆ†ã€‚");
  } else if (rev < 0.05 && eps < 0.05) {
    lines.push("æˆé•·ï¼šç‡Ÿæ”¶èˆ‡ EPS æˆé•·åå¼±ï¼ˆæˆ–è¶¨ç·©ï¼‰ï¼Œä½¿æˆé•·è©•åˆ†å—å£“ã€‚");
  } else {
    lines.push("æˆé•·ï¼šæˆé•·å‹•èƒ½åˆ†æ­§ï¼ˆç‡Ÿæ”¶èˆ‡ EPS ä¸€å¼·ä¸€å¼±ï¼‰ï¼Œå»ºè­°ç•™æ„å¯æŒçºŒæ€§ã€‚");
  }

  const roe = d.roe;
  const roic = d.roic;
  if (roe == null || roic == null) {
    lines.push("å“è³ªï¼šROE/ROIC æŒ‡æ¨™ç¼ºå€¼ï¼Œç„¡æ³•å®Œæ•´åˆ¤æ–·è³‡æœ¬æ•ˆç‡ã€‚");
  } else if (roe >= 0.2 && roic >= 0.15) {
    lines.push("å“è³ªï¼šROE èˆ‡ ROIC çš†åé«˜ï¼Œä»£è¡¨è³‡æœ¬æ•ˆç‡èˆ‡ç²åˆ©å“è³ªè‰¯å¥½ã€‚");
  } else if (roe < 0.1 || roic < 0.08) {
    lines.push("å“è³ªï¼šROE æˆ– ROIC åä½ï¼Œé¡¯ç¤ºè³‡æœ¬æ•ˆç‡è¼ƒä¿å®ˆï¼Œå“è³ªè©•åˆ†åå¼±ã€‚");
  } else {
    lines.push("å“è³ªï¼šè³‡æœ¬æ•ˆç‡è½åœ¨ä¸­æ®µæ°´æº–ï¼Œå±¬æ–¼ç©©å®šä½†ä¸æ¥µå¼·çš„å“è³ªçµæ§‹ã€‚");
  }

  const pe = d.pe;
  const fcfy = d.fcf_yield;
  if (pe == null || fcfy == null) {
    lines.push("ä¼°å€¼ï¼šä¼°å€¼æŒ‡æ¨™ç¼ºå€¼ï¼Œå»ºè­°è£œé½Š PE èˆ‡ FCF æ®–åˆ©ç‡å†è©•ä¼°ã€‚");
  } else if (pe <= 20 && fcfy >= 0.04) {
    lines.push("ä¼°å€¼ï¼šPE ååˆç†ä¸” FCF æ®–åˆ©ç‡è¼ƒä½³ï¼Œä¼°å€¼é¢ç›¸å°å‹å–„ã€‚");
  } else if (pe > 30 && fcfy < 0.02) {
    lines.push("ä¼°å€¼ï¼šPE åé«˜ä¸” FCF æ®–åˆ©ç‡åä½ï¼Œä¼°å€¼è©•åˆ†å®¹æ˜“è¢«æ‹‰ä½ã€‚");
  } else {
    lines.push("ä¼°å€¼ï¼šä¼°å€¼è½åœ¨ä¸­æ€§å€é–“ï¼Œå»ºè­°æ­é…æˆé•·æ€§ä¸€èµ·è¡¡é‡æ˜¯å¦åˆç†ã€‚");
  }

  return lines.slice(0, 3);
}

function yn(ok){ return ok ? "âœ…" : "âŒ"; }

function buildHealthChecks(d) {
  // 1. å®‰å…¨è½‰æ›å‡½å¼ï¼šè™•ç† null/undefined/ç©ºå­—ä¸²
  const safeNum = (v) => {
    if (v === null || v === undefined || v === "") return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };

  // --- è®€å–æ¬„ä½ (è®Šæ•¸åç¨±å°æ‡‰ä½ çš„è³‡æ–™åº«æ¬„ä½) ---
  const rev_g    = safeNum(d.revenue_growth);     // ç‡Ÿæ”¶æˆé•·ç‡
  const eps_g    = safeNum(d.eps_growth);         // EPS æˆé•·ç‡
  const fcf_g    = safeNum(d.fcf_growth);         // FCF æˆé•·ç‡
  const div_g    = safeNum(d.dividend_growth);    // è‚¡æ¯æˆé•·ç‡
  
  const roic     = safeNum(d.roic);               // è³‡æœ¬å›å ±ç‡
  const roe      = safeNum(d.roe);                // è‚¡æ±æ¬Šç›Šå ±é…¬ç‡
  const beta     = safeNum(d.beta);               // æ³¢å‹•ç‡
  const peg      = safeNum(d.peg);                // PEG
  
  const dy       = safeNum(d.dividendyield);      // ç¾é‡‘æ®–åˆ©ç‡
  const payout   = safeNum(d.dividendpayoutratio);// é…æ¯ç‡
  
  const pe       = safeNum(d.pe);                 // æœ¬ç›Šæ¯”
  const pb       = safeNum(d.pb);                 // è‚¡åƒ¹æ·¨å€¼æ¯”
  const ev_ebitda= safeNum(d.evtoebitda);         // ä¼æ¥­åƒ¹å€¼å€æ•¸ (EV/EBITDA)
  const p_fcf    = safeNum(d.p_fcf);              // è‚¡åƒ¹è‡ªç”±ç¾é‡‘æµæ¯” (P/FCF)
  
  const curr_r   = safeNum(d.current_ratio);      // æµå‹•æ¯” (çŸ­æœŸå„Ÿå‚µ)
  const net_d_e  = safeNum(d.net_debt_to_ebitda); // æ·¨è² å‚µ/EBITDA (é•·æœŸå„Ÿå‚µ)
  const de_ratio = safeNum(d.debt_to_equity);     // è² å‚µæ¬Šç›Šæ¯”

  // --- 2. å®šç¾©å››å¤§é¡å‹çš„æª¢æŸ¥é‚è¼¯ ---

  // A. æˆé•·å‹ (Growth) - çœ‹é‡æˆé•·å‹•èƒ½èˆ‡æ•ˆç‡
  const growthChecks = [
    { label: "ç‡Ÿæ”¶æˆé•· â‰¥ 10%",   ok: rev_g !== null && rev_g >= 0.10 },
    { label: "EPS æˆé•· â‰¥ 10%",   ok: eps_g !== null && eps_g >= 0.10 },
    { label: "FCF æˆé•· > 0%",    ok: fcf_g !== null && fcf_g > 0 }, // çœŸé‡‘ç™½éŠ€ä¹Ÿè¦æˆé•·
    { label: "PEG â‰¤ 2.0",        ok: peg !== null && peg > 0 && peg <= 2.0 }, // æˆé•·è‚¡å¯ä»¥æ¥å—ç¨é«˜ä¼°å€¼ï¼Œä½†ä¸èƒ½é›¢è­œ
  ];

  // B. å®šå­˜/å­˜è‚¡å‹ (Dividend/Income) - çœ‹é‡æ®–åˆ©ç‡èˆ‡é…æ¯å®‰å…¨æ€§
  const incomeChecks = [
    // 1. æ®–åˆ©ç‡é–€æª» (ä¾‹å¦‚ 4%)
    { label: "ç¾é‡‘æ®–åˆ©ç‡ â‰¥ 4%",  ok: dy !== null && dy >= 0.04 },
    // 2. é…æ¯ç‡ < 90% (è³º 100 ç™¼ 90 å…§ç®—å®‰å…¨ï¼Œè¶…é 100 ä»£è¡¨è€æœ¬æˆ–å€ŸéŒ¢ç™¼)
    // è¨»ï¼šREITs é¡è‚¡é€šå¸¸æœƒé«˜æ–¼ 90%ï¼Œä¸€èˆ¬å…¬å¸å‰‡ä¸å®œéé«˜
    { label: "é…æ¯ç‡ â‰¤ 90%",     ok: payout !== null && payout > 0 && payout <= 0.90 },
    // 3. è‚¡æ¯æœ‰æˆé•· (æŠ—é€šè†¨)
    { label: "è‚¡æ¯æˆé•· > 0",     ok: div_g !== null && div_g > 0 },
    // 4. æ³¢å‹•ä½ (æ™šä¸Šç¡å¾—è‘—)
    { label: "ä½æ³¢å‹• (Î² < 1)",   ok: beta !== null && beta < 1.0 },
  ];

  // C. åƒ¹å€¼å‹ (Value) - çœ‹é‡ä¾¿å®œä¼°å€¼
  const valueChecks = [
    // 1. æœ¬ç›Šæ¯”ä¾¿å®œ
    { label: "PE â‰¤ 15",          ok: pe !== null && pe > 0 && pe <= 15 },
    // 2. EV/EBITDA (æ¯” PE æ›´å°ˆæ¥­çš„ä¼°å€¼ï¼Œé€šå¸¸ < 12 ç®—ä¾¿å®œ)
    { label: "EV/EBITDA â‰¤ 12",   ok: ev_ebitda !== null && ev_ebitda > 0 && ev_ebitda <= 12 },
    // 3. P/FCF (è‚¡åƒ¹/è‡ªç”±ç¾é‡‘æµï¼Œè¶Šä½è¶Šå¥½ï¼Œ< 20 ä»£è¡¨ 5% FCF Yield)
    { label: "P/FCF â‰¤ 20",       ok: p_fcf !== null && p_fcf > 0 && p_fcf <= 20 },
    // 4. è‚¡åƒ¹æ·¨å€¼æ¯” (å‚³çµ±åƒ¹å€¼æŒ‡æ¨™)
    { label: "PB â‰¤ 1.5",         ok: pb !== null && pb > 0 && pb <= 1.5 },
  ];

  // D. æ’é™¤åœ°é›·è‚¡ (Safety) - çœ‹é‡å„Ÿå‚µèƒ½åŠ›èˆ‡åŸºæœ¬ç²åˆ©
  const riskChecks = [
    // 1. æµå‹•æ¯” > 1 (çŸ­æœŸèƒ½é‚„éŒ¢)
    { label: "æµå‹•æ¯” â‰¥ 1",       ok: curr_r !== null && curr_r >= 1.0 },
    // 2. æ·¨è² å‚µæ¯” < 4 (é‚„å‚µå£“åŠ›æ¸¬è©¦ï¼Œè¶Šä½è¶Šå¥½)
    { label: "æ·¨è² å‚µ/EBITDA â‰¤ 4",ok: net_d_e !== null && net_d_e <= 4.0 }, 
    // 3. è² å‚µæ¯” (ä¸å®œéåº¦æ§“æ¡¿)
    { label: "è² å‚µæ¬Šç›Šæ¯” â‰¤ 2",   ok: de_ratio !== null && de_ratio <= 2.0 },
    // 4. åŸºæœ¬ç²åˆ©èƒ½åŠ› (æ²’è™§éŒ¢)
    { label: "ROE > 0",          ok: roe !== null && roe > 0 },
  ];

  // --- 3. æ‰“åŒ…å›å‚³ ---
  function pack(title, checks){
    const pass = checks.filter(c => c.ok).length;
    const total = checks.length;
    const ratio = pass / total;
    const level = ratio >= 0.75 ? "good" : ratio >= 0.5 ? "mid" : "bad";
    const label = ratio >= 0.75 ? "åç¬¦åˆ" : ratio >= 0.5 ? "ä¸­æ€§" : "åä¸ç¬¦åˆ";
    return { title, checks, pass, total, level, label };
  }

  return [
    pack("æˆé•·å‹æŠ•è³‡é©é…åº¦", growthChecks),
    pack("å®šå­˜å‹æŠ•è³‡é©é…åº¦", incomeChecks),
    pack("åƒ¹å€¼å‹æŠ•è³‡é©é…åº¦", valueChecks),
    pack("è²¡å‹™å¥åº·èˆ‡é¿é›·", riskChecks),
  ];
}

function renderHealthSection(d){
  const host = document.getElementById("health");
  if (!host) return;

  const blocks = buildHealthChecks(d);

  // ä¿®æ”¹ renderHealthSection å‡½å¼å…§éƒ¨çš„ blocks.map éƒ¨åˆ†
  host.innerHTML = `
      <div class="healthCard">
        <div class="healthHeader">
          <h3>æŠ•è³‡é¢¨æ ¼é©é…åº¦åˆ†æ</h3>
        </div>

        <div class="healthGrid">
          ${blocks.map(b => `
            <div class="healthBox">
              <div class="healthBoxTitle">
                <b>${b.title}</b>
                <span class="hpill ${b.level}">${b.pass}/${b.total} Â· ${b.label}</span>
              </div>
              <ul class="healthList">
                ${b.checks.map(c => {
                  // å–å¾—å°æ‡‰çš„è§£é‡‹ï¼Œå¦‚æœæ²’æœ‰å®šç¾©å‰‡ä¸é¡¯ç¤º Tooltip
                  const tip = METRIC_DEFINITIONS[c.label] || "";
                  return `
                    <li>
                      ${yn(c.ok)} 
                      <span class="${tip ? 'item-help' : ''}" data-tip="${tip}">
                        ${c.label}
                      </span>
                    </li>`;
                }).join("")}
              </ul>
            </div>
          `).join("")}
        </div>
        `;
}

async function loadSnapshot() {
  if (!symbol) {
    document.getElementById("title").innerText = "æ‡‚æ‰æŠ±ï½œè²¡å ±å¿«ç…§";
    document.getElementById("snapshot").className = "state";
    document.getElementById("snapshot").innerText = "ç¶²å€ç¼ºå°‘ symbolï¼Œä¾‹å¦‚ï¼šanalysis.html?symbol=AAPL";
    return;
  }
  
    // ===== å…ˆè®€æ–¹æ¡ˆï¼ˆæ¬Šé™åŸºç¤ï¼‰=====
  const planInfo = await getCurrentUserPlan();
  __user = planInfo.user;
  __plan = planInfo.plan || "free";
  __isPro = (__plan === "pro");
  setPlanUI(__plan);

  document.getElementById("tvLink").href = `https://www.tradingview.com/symbols/NASDAQ-${symbol}/`;
  document.getElementById("yfLink").href = `https://finance.yahoo.com/quote/${symbol}`;

  // é€™è£¡ä¹Ÿè¦è·Ÿè‘—æ”¹å
    const { data, error } = await sbData
    .from("core_metrics")
    .select("*")
    .eq("symbol", symbol)
    .single();

  if (error || !data) {
    document.getElementById("title").innerText = `${symbol}ï½œè²¡å ±å¿«ç…§`;
    document.getElementById("snapshot").className = "state";
    document.getElementById("snapshot").innerText = "æ‰¾ä¸åˆ°è³‡æ–™ï¼ˆå¯èƒ½å°šæœªå¯«å…¥ core_metricsï¼‰ã€‚";
    document.getElementById("trends").innerHTML = "";
    document.getElementById("health").innerHTML = "";
    return;
  }

  const s = calculateScore(data);
  const insight = buildInsight(data, s);

  document.getElementById("title").innerText = `${data.symbol}ï½œè²¡å ±å¿«ç…§`;

  const scoreP = clamp(s.total, 0, 100);
  const qP = clamp(Math.round((s.quality/40)*100), 0, 100);
  const gP = clamp(Math.round((s.growth/30)*100), 0, 100);
  const vP = clamp(Math.round((s.valuation/30)*100), 0, 100);

  document.getElementById("snapshot").className = "";
  document.getElementById("snapshot").innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <h3 class="cardTitle">å¿«ç…§è©•åˆ†</h3>
          <span class="pill">Snapshot Score</span>
        </div>

        <div class="scoreWrap" style="--ringColor:${s.ringColor};">
          <div class="ring" style="--p:${scoreP}; --ringColor:${s.ringColor};">
            <div class="ringInner">
              <div class="scoreNum">${s.total}</div>
              <div class="scoreDen">/ 100</div>
              <div class="grade">${s.grade}</div>
            </div>
          </div>

          <div class="bars">
            <div class="barRow">
              <div class="barTop"><span>å“è³ª</span><span>${s.quality}/40</span></div>
              <div class="bar"><div style="--w:${qP}%; --ringColor:${s.ringColor};"></div></div>
            </div>
            <div class="barRow">
              <div class="barTop"><span>æˆé•·</span><span>${s.growth}/30</span></div>
              <div class="bar"><div style="--w:${gP}%; --ringColor:${s.ringColor};"></div></div>
            </div>
            <div class="barRow">
              <div class="barTop"><span>ä¼°å€¼</span><span>${s.valuation}/30</span></div>
              <div class="bar"><div style="--w:${vP}%; --ringColor:${s.ringColor};"></div></div>
            </div>

            <div class="note">
              è©•åˆ†ç”¨æ–¼å¿«é€Ÿæ¯”è¼ƒå…¬å¸ç²åˆ©å“è³ªã€æˆé•·æ€§èˆ‡ä¼°å€¼æ°´æº–ï¼›åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚
            </div>

            <div class="insight">
              <div class="insightTitle">
                <h4>AI å¿«é€Ÿè§£è®€</h4>
                <span class="tag">Snapshot Insight</span>
              </div>
              <ul>
                <li>${insight[0]}</li>
                <li>${insight[1]}</li>
                <li>${insight[2]}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h3 class="cardTitle">å…¬å¸å¿«ç…§</h3>
          <span class="pill">core_metrics</span>
        </div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="kLabel">å¸‚å€¼</div>
            <div class="kVal">${fmtCap(data.market_cap)}</div>
            <div class="kHint">Market Cap</div>
          </div>

          <div class="kpi">
            <div class="kLabel">PE</div>
            <div class="kVal">${data.pe == null ? "â€”" : fmtNum(data.pe, 1)}</div>
            <div class="kHint">Price / Earnings</div>
          </div>

          <div class="kpi">
            <div class="kLabel">PEG</div>
            <div class="kVal">${data.peg == null ? "â€”" : fmtNum(data.peg, 2)}</div>
            <div class="kHint">PEG Ratio</div>
          </div>

          <div class="kpi">
            <div class="kLabel">ROE</div>
            <div class="kVal">${fmtPct(data.roe, 1)}</div>
            <div class="kHint">Equity Return</div>
          </div>

          <div class="kpi">
            <div class="kLabel">ROIC</div>
            <div class="kVal">${fmtPct(data.roic, 1)}</div>
            <div class="kHint">Invested Capital</div>
          </div>

          <div class="kpi">
            <div class="kLabel">FCF æ®–åˆ©ç‡</div>
            <div class="kVal">${fmtPct(data.fcf_yield, 1)}</div>
            <div class="kHint">Free Cash Flow</div>
          </div>

          <div class="kpi">
            <div class="kLabel">ç‡Ÿæ”¶ YoY</div>
            <div class="kVal">${fmtPct(data.revenue_growth, 1)}</div>
            <div class="kHint">Revenue Growth</div>
          </div>

          <div class="kpi">
            <div class="kLabel">EPS YoY</div>
            <div class="kVal">${fmtPct(data.eps_growth, 1)}</div>
            <div class="kHint">EPS Growth</div>
          </div>

          <div class="kpi">
            <div class="kLabel">Î²</div>
            <div class="kVal">${data.beta == null ? "â€”" : fmtNum(data.beta, 2)}</div>
            <div class="kHint">Volatility</div>
          </div>
        </div>

        <div class="note">
          è‹¥å°æ–¼å…¬å¸è³‡è¨ŠåŠè²¡å ±ç›¸é—œå…§å®¹æœ‰æ›´è©³ç´°éœ€æ±‚ï¼Œå¯ä½¿ç”¨æ‡‚æ‰æŠ±å¾ŒçºŒæœå‹™
        </div>
      </div>
    </div>
  `;

  // å…ˆç•«å¥è¨ºï¼ˆåœ¨è¶¨å‹¢ä¸‹é¢ï¼Œè‡ªæˆä¸€æ ¼ï¼‰
  renderHealthSection(data);

  // å†è¼‰å…¥è¶¨å‹¢åœ–ï¼ˆåªå‘¼å«ä¸€æ¬¡ï¼‰
  requestAnimationFrame(async () => {
  await loadQuickTrends(symbol);

  // ===== Pro-only å€å¡Šï¼ˆå…ˆç•™å…¥å£ï¼Œä¹‹å¾ŒåŠ æŒ‡æ¨™å°±æ”¾é€™è£¡ï¼‰=====
  if (requireProOrShowCard()) {
    try {
      const pro = await loadProMetrics(symbol);
      renderProCard(pro);
    } catch (e) {
      // Pro ä½†æŠ“ä¸åˆ°è³‡æ–™ï¼šé¡¯ç¤ºéŒ¯èª¤ï¼ˆä¸å½±éŸ¿å…¶ä»–å€å¡Šï¼‰
      const host = document.getElementById("trends");
      if (host) {
        host.insertAdjacentHTML("beforeend", `
          <div class="card" style="margin-top:14px;">
            <div class="note">Pro æŒ‡æ¨™è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>
          </div>
        `);
      }
    }
  }
});
}

loadSnapshot();
</script>
</body>
</html>
