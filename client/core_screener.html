<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ‡‚æ‰æŠ±ï¼æ ¸å¿ƒæŒ‡æ¨™é¸è‚¡å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="css/core_screener.css" />
</head>
<body>
  <div class="container">
    <div class="header-row">
        <div>
            <h1>æ‡‚æ‰æŠ±æ ¸å¿ƒæŒ‡æ¨™é¸è‚¡å™¨</h1>
            <p class="subtitle">ä»¥ä¸‹è³‡æ–™æ¯æ—¥å®šæœŸæ›´æ–°ï¼Œç¥å„ä½å·´è²ç‰¹æŠ•è³‡é †å¿ƒ</p>
        </div>
        <div class="search-section">
            <input type="text" id="stockInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚: NVDA)" />
            <button id="btnGoSnapshot">æŸ¥çœ‹å¿«ç…§</button>
        </div>
    </div>
    <div class="filters-container">

  <div class="preset-section">
    <div class="preset-label"> å¿«é€Ÿç­–ç•¥ï¼š</div>
    <div class="preset-bar">
        <button class="preset-btn" data-preset="buffett">å·´è²ç‰¹é¢¨æ ¼</button>
        <button class="preset-btn" data-preset="dividend">é«˜è‚¡æ¯</button>
        <button class="preset-btn" data-preset="growth">é«˜æˆé•·</button>
        <button class="preset-btn" data-preset="value">åƒ¹å€¼è‚¡</button>
        <button class="preset-btn" data-preset="lynch">å½¼å¾—æ—å€</button>
        <button class="preset-btn" data-preset="magic">é­”æ³•å…¬å¼</button>
        <button class="preset-btn" data-preset="compounder">è¤‡åˆ©æˆé•·</button>
        <button class="preset-btn" data-preset="lowvol">ä½æ³¢å‹•</button>
        <button id="btnClearAll" class="preset-btn" style="background-color: #6c757d;"> æ¸…ç©ºå…¨éƒ¨æ¢ä»¶</button>
    </div>
  </div>

  <div class="filter-section">
    <div class="section-header" onclick="toggleSection(this)">
      <h3 class="section-title"> åŸºæœ¬é¢èˆ‡ç”¢æ¥­</h3>
      <span class="toggle-icon">â–¼</span>
    </div>
    <div class="section-content">
      <div class="filter-grid">
        <div class="filter-group">
            <label>å¸‚å€¼ç¯©é¸</label>
            <select id="capFilter"><option value="all">å…¨éƒ¨</option><option value="mega">è¶…å¤§å‹</option><option value="large">å¤§å‹</option><option value="mid">ä¸­å‹</option><option value="small">å°å‹</option></select>
        </div>
        <div class="filter-group">
            <label>ç”¢æ¥­</label>
            <select id="sectorFilter"><option value="all">å…¨éƒ¨</option><option value="Technology">ç§‘æŠ€</option><option value="Financial Services">é‡‘è</option><option value="Healthcare">é†«ç™‚</option><option value="Consumer Cyclical">å¾ªç’°æ¶ˆè²»</option><option value="Consumer Defensive">é˜²ç¦¦æ¶ˆè²»</option><option value="Energy">èƒ½æº</option><option value="Industrials">å·¥æ¥­</option><option value="Utilities">å…¬ç”¨</option><option value="Real Estate">åœ°ç”¢</option><option value="Basic Materials">åŸç‰©æ–™</option></select>
        </div>
        <div class="filter-group">
            <label>Beta</label>
            <select id="betaFilter"><option value="all">ä¸é™</option><option value="1.5">1.5</option><option value="1.2">1.2</option><option value="1.0">1.0</option><option value="0.8">0.8</option></select>
        </div>
      </div>
    </div>
  </div>

  <div class="filter-section">
    <div class="section-header" onclick="toggleSection(this)">
      <h3 class="section-title"> ä¼°å€¼èˆ‡åƒ¹æ ¼</h3>
      <span class="toggle-icon">â–¼</span>
    </div>
    <div class="section-content">
      <div class="filter-grid">
        <div class="filter-group"><label>PE æœ¬ç›Šæ¯”</label><select id="peFilter"><option value="all">ä¸é™</option><option value="40">40</option><option value="30">30</option><option value="20">20</option><option value="15">15</option><option value="10">10</option></select></div>
        <div class="filter-group"><label>PEG</label><select id="pegFilter"><option value="all">ä¸é™</option><option value="2">2.0</option><option value="1.5">1.5</option><option value="1">1.0</option><option value="0.5">0.5</option></select></div>
        <div class="filter-group"><label>PB æ·¨å€¼æ¯”</label><select id="pbFilter"><option value="all">ä¸é™</option><option value="5">5</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div>
        <div class="filter-group"><label>PS ç‡Ÿæ”¶æ¯”</label><select id="psFilter"><option value="all">ä¸é™</option><option value="10">10</option><option value="5">5</option><option value="3">3</option></select></div>
        <div class="filter-group"><label>P/FCF</label><select id="pfcfFilter"><option value="all">ä¸é™</option><option value="30">30</option><option value="20">20</option><option value="15">15</option></select></div>
        <div class="filter-group"><label>EV/EBITDA</label><select id="evFilter"><option value="all">ä¸é™</option><option value="20">20</option><option value="15">15</option><option value="10">10</option></select></div>
        <div class="filter-group"><label>ç›ˆé¤˜æ®–åˆ©ç‡</label><select id="eyFilter"><option value="0">ä¸é™</option><option value="0.04">4%</option><option value="0.06">6%</option><option value="0.08">8%</option></select></div>
        <div class="filter-group"><label>FCF æ®–åˆ©ç‡</label><select id="fcfFilter"><option value="0">ä¸é™</option><option value="0.02">2%</option><option value="0.04">4%</option><option value="0.06">6%</option></select></div>
      </div>
    </div>
  </div>

  <div class="filter-section">
    <div class="section-header" onclick="toggleSection(this)">
      <h3 class="section-title"> ç²åˆ©èƒ½åŠ›</h3>
      <span class="toggle-icon">â–¼</span>
    </div>
    <div class="section-content">
      <div class="filter-grid">
        <div class="filter-group"><label>ROE</label><select id="roeFilter"><option value="0">ä¸é™</option><option value="10">10%</option><option value="15">15%</option><option value="20">20%</option><option value="30">30%</option></select></div>
        <div class="filter-group"><label>ROIC</label><select id="roicFilter"><option value="0">ä¸é™</option><option value="0.10">10%</option><option value="0.15">15%</option><option value="0.20">20%</option></select></div>
        <div class="filter-group"><label>æ¯›åˆ©ç‡</label><select id="gmFilter"><option value="0">ä¸é™</option><option value="0.3">30%</option><option value="0.4">40%</option><option value="0.5">50%</option></select></div>
        <div class="filter-group"><label>ç‡Ÿç›Šç‡</label><select id="omFilter"><option value="0">ä¸é™</option><option value="0.1">10%</option><option value="0.15">15%</option><option value="0.2">20%</option></select></div>
      </div>
    </div>
  </div>

  <div class="filter-section">
    <div class="section-header" onclick="toggleSection(this)">
      <h3 class="section-title"> è²¡å‹™é«”è³ª</h3>
      <span class="toggle-icon">â–¼</span>
    </div>
    <div class="section-content">
      <div class="filter-grid">
        <div class="filter-group"><label>è² å‚µ/æ¬Šç›Š</label><select id="deFilter"><option value="all">ä¸é™</option><option value="2">2.0</option><option value="1.5">1.5</option><option value="1">1.0</option><option value="0.5">0.5</option></select></div>
        <div class="filter-group"><label>è² å‚µ/è³‡ç”¢</label><select id="daFilter"><option value="all">ä¸é™</option><option value="0.8">0.8</option><option value="0.6">0.6</option><option value="0.4">0.4</option></select></div>
        <div class="filter-group"><label>æ·¨è² å‚µ/EBITDA</label><select id="ndFilter"><option value="all">ä¸é™</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div>
        <div class="filter-group"><label>æµå‹•æ¯”ç‡</label><select id="crFilter"><option value="0">ä¸é™</option><option value="1">1.0</option><option value="1.5">1.5</option><option value="2">2.0</option></select></div>
        <div class="filter-group"><label>CCC ç¾é‡‘å¾ªç’°</label><select id="cccFilter"><option value="all">ä¸é™</option><option value="neg">å°æ–¼ 0</option><option value="pos">å¤§æ–¼ 0</option></select></div>
      </div>
    </div>
  </div>

  <div class="filter-section">
    <div class="section-header" onclick="toggleSection(this)">
      <h3 class="section-title"> æˆé•·èˆ‡è‚¡æ¯</h3>
      <span class="toggle-icon">â–¼</span>
    </div>
    <div class="section-content">
      <div class="filter-grid">
        <div class="filter-group"><label>ç‡Ÿæ”¶æˆé•·</label><select id="rgFilter"><option value="0">ä¸é™</option><option value="0.05">5%</option><option value="0.1">10%</option><option value="0.15">15%</option></select></div>
        <div class="filter-group"><label>EPS æˆé•·</label><select id="egFilter"><option value="0">ä¸é™</option><option value="0.05">5%</option><option value="0.1">10%</option><option value="0.2">20%</option></select></div>
        <div class="filter-group"><label>FCF æˆé•·</label><select id="fgFilter"><option value="0">ä¸é™</option><option value="0.05">5%</option><option value="0.1">10%</option><option value="0.2">20%</option></select></div>
        <div class="filter-group"><label>è‚¡æ¯æ®–åˆ©ç‡</label><select id="dyFilter"><option value="0">ä¸é™</option><option value="0.02">2%</option><option value="0.03">3%</option><option value="0.04">4%</option><option value="0.05">5%</option></select></div>
        <div class="filter-group"><label>é…æ¯ç‡</label><select id="dpFilter"><option value="all">ä¸é™</option><option value="0.8">80%</option><option value="0.6">60%</option><option value="0.4">40%</option></select></div>
        <div class="filter-group"><label>è‚¡æ¯æˆé•·</label><select id="dgFilter"><option value="0">ä¸é™</option><option value="0.03">3%</option><option value="0.05">5%</option><option value="0.1">10%</option></select></div>
      </div>
    </div>
  </div>

</div>

</div>

    <div class="summary" id="summaryText">è¼‰å…¥ä¸­...</div>

    <table>
      <thead>
        <tr>
          <th data-sort="symbol">è‚¡ç¥¨ä»£è™Ÿ</th>
          <th data-sort="market_cap">å¸‚å€¼</th>
          <th data-sort="sector">ç”¢æ¥­</th>
          <th data-sort="beta">Î²</th>
          <th data-sort="roa">ROAï¼ˆè³‡ç”¢å ±é…¬ç‡ï¼‰</th>
          <th data-sort="roe">ROEï¼ˆè‚¡æ±æ¬Šç›Šå ±é…¬ç‡ï¼‰</th>
          <th data-sort="roic">ROICï¼ˆæŠ•å…¥è³‡æœ¬å ±é…¬ç‡ï¼‰</th>
          <th data-sort="fcf_yield">FCF æ®–åˆ©ç‡</th>
          <th data-sort="earnings_yield">ç›ˆé¤˜æ®–åˆ©ç‡</th>
          <th data-sort="current_ratio">æµå‹•æ¯”ç‡</th>
          <th data-sort="net_debt_to_ebitda">æ·¨è² å‚µ / EBITDA</th>
          <th data-sort="ccc">ç¾é‡‘è½‰æ›é€±æœŸï¼ˆCCCï¼‰</th>
          <th data-sort="pe">æœ¬ç›Šæ¯”ï¼ˆPEï¼‰</th>
          <th data-sort="peg">æœ¬ç›Šæˆé•·æ¯”ï¼ˆPEGï¼‰</th>
          <th data-sort="ps">è‚¡åƒ¹ç‡Ÿæ”¶æ¯”ï¼ˆP/Sï¼‰</th>
          <th data-sort="pb">è‚¡åƒ¹æ·¨å€¼æ¯”ï¼ˆP/Bï¼‰</th>
          <th data-sort="p_fcf">è‚¡åƒ¹ / FCF</th>
          <th data-sort="debt_to_equity">è² å‚µ / è‚¡æ±æ¬Šç›Š</th>
          <th data-sort="debt_to_asset">è² å‚µ / è³‡ç”¢</th>
          <th data-sort="dividendyield">è‚¡æ¯æ®–åˆ©ç‡</th>
          <th data-sort="dividendpershare">æ¯è‚¡è‚¡æ¯</th>
          <th data-sort="dividendpayoutratio">é…æ¯ç‡</th>
          <th data-sort="grossmargin">æ¯›åˆ©ç‡</th>
          <th data-sort="operatingmargin">ç‡Ÿæ¥­åˆ©ç›Šç‡</th>
          <th data-sort="evtoebitda">EV / EBITDA</th>
          <th data-sort="revenue_growth">ç‡Ÿæ”¶å¹´å¢ç‡</th>
          <th data-sort="eps_growth">EPS å¹´å¢ç‡</th>
          <th data-sort="fcf_growth">FCF å¹´å¢ç‡</th>
          <th data-sort="dividend_growth">è‚¡æ¯å¹´å¢ç‡</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div id="loadMoreContainer" style="text-align: center; margin: 30px 0; display: none;">
        <button id="btnLoadMore" type="button" class="load-more-btn" style="background-color: #2563eb; padding: 12px 40px; font-size: 1rem; color: white; border: none; border-radius: 999px; cursor: pointer;">
          é¡¯ç¤ºæ›´å¤šè‚¡ç¥¨ (ç›®å‰å·²é¡¯ç¤º <span id="currentCountText">0</span> æª”)
      </button>
    </div>
  </div>

  <script>
  // === Supabase è¨­å®š ===
  const SUPABASE_URL = "https://ojeirmqxborwxhuwuems.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_wur9F2qRW0NFyZpijPub2A__IsGlpgZ";

  // ã€ä¿®æ­£é» 1ã€‘è®Šæ•¸æ”¹åç‚º supabaseClient
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let allRows = [];
  let sortState = { key: "market_cap", dir: "desc" };
  // --- æ–°å¢é€™å…©è¡Œ ---
  let displayedCount = 50;       // æ‰‹æ©Ÿç‰ˆé è¨­é¡¯ç¤º 50 ç­†
  let currentFilteredRows = [];  // å„²å­˜ç›®å‰ç¯©é¸å®Œå¾Œçš„å®Œæ•´è³‡æ–™

  function formatCap(x) {
    if (x == null) return "-";
    if (x >= 1e12) return (x / 1e12).toFixed(2) + " å…†";
    if (x >= 1e9)  return (x / 1e9 ).toFixed(2) + " å„„";
    if (x >= 1e6)  return (x / 1e6 ).toFixed(2) + " ç™¾è¬";
    return x.toLocaleString();
  }
  function pct(x) {
    if (x == null) return "-";
    return (x * 100).toFixed(2) + "%";
  }

  // ğŸ”¹ å¢å¼·ç‰ˆå°å·¥å…·ï¼šè¨­å®š select å€¼ï¼Œä¸¦é»äº®/å±•é–‹å°æ‡‰å€å¡Š
function setSelect(id, value) {
  const el = document.getElementById(id);
  if (!el) return;

  // 1. è¨­å®šæ•¸å€¼
  el.value = value;

  // 2. è™•ç†è¦–è¦ºé«˜äº® (è®“ä½¿ç”¨è€…çŸ¥é“å“ªäº›è¢«æ”¹äº†)
  const group = el.closest('.filter-group');
  if (group) {
    if (value !== "0" && value !== "all") {
      group.classList.add("filter-active"); // è‡ªå®šç¾©çš„é«˜äº® class
    } else {
      group.classList.remove("filter-active");
    }
  }

  // 3. è‡ªå‹•å±•é–‹æ‰€å±¬çš„æ‘ºç–Šå€å¡Š (å¦‚æœå€å¡Šæ˜¯æ”¶èµ·ä¾†çš„)
  const section = el.closest('.filter-section');
  if (section && value !== "0" && value !== "all") {
      section.classList.add("active");
  }
}

// --- æ–°å¢ 1ï¼šå„²å­˜ç›®å‰çš„å®Œæ•´ç‹€æ…‹ ---
function saveAllStates() {
  const state = {
    filters: {},
    activePreset: sessionStorage.getItem("activePreset") || "" 
  };

  // æŠ“å–æ‰€æœ‰é¸å–®çš„å€¼
  document.querySelectorAll('.filter-section select').forEach(select => {
    state.filters[select.id] = select.value;
  });

  sessionStorage.setItem("screener_state", JSON.stringify(state));
}

// --- æ–°å¢ 2ï¼šé‚„åŸå®Œæ•´ç‹€æ…‹ ---
function restoreAllStates() {
  const savedData = sessionStorage.getItem("screener_state");
  if (!savedData) return false;

  const state = JSON.parse(savedData);

  // 1. é‚„åŸæ‰€æœ‰ä¸‹æ‹‰é¸å–®çš„å€¼
  Object.keys(state.filters).forEach(id => {
    const val = state.filters[id];
    setSelect(id, val); // é€™æœƒè§¸ç™¼ä½ åŸæœ¬å¯«å¥½çš„é«˜äº®èˆ‡å±•é–‹é‚è¼¯
  });

  // 2. é‚„åŸé¢¨æ ¼æŒ‰éˆ•çš„é«˜äº®ç‹€æ…‹
  if (state.activePreset) {
    document.querySelectorAll(".preset-btn").forEach(btn => {
      btn.classList.remove("active");
      if (btn.dataset.preset === state.activePreset) btn.classList.add("active");
    });
  }
  return true;
}
  // ğŸ”¹ ä¸€éµç­–ç•¥ï¼šä¾åç¨±èª¿æ•´æ‰€æœ‰ç¯©é¸å™¨
function applyPreset(name) {
  // === æ–°å¢ï¼šå°‡é¸æ“‡çš„ç­–ç•¥å„²å­˜åˆ° sessionStorage ===
  sessionStorage.setItem("activePreset", name);

  // 1. è™•ç†æŒ‰éˆ•é«˜äº®
  document.querySelectorAll(".preset-btn").forEach(btn => {
    btn.classList.remove("active");
    if (btn.dataset.preset === name) btn.classList.add("active");
  });

  // 2. å…¨åŸŸé‡ç½® (æ¸…ç©ºä¹‹å‰çš„é«˜äº®èˆ‡æ•¸å€¼)
  document.querySelectorAll('.filter-group').forEach(g => g.classList.remove("filter-active"));
  // å…ˆä¸è¦é—œé–‰æ‰€æœ‰ sectionï¼Œä¿ç•™ä½¿ç”¨è€…åŸæœ¬é–‹å•Ÿçš„ï¼Œæˆ–è€…è¦–éœ€æ±‚åŠ ï¼š
  // document.querySelectorAll('.filter-section').forEach(s => s.classList.remove("active"));

  const allSelects = [
    "capFilter","roeFilter","roicFilter","fcfFilter","eyFilter","crFilter",
    "ndFilter","cccFilter","peFilter","pegFilter","psFilter","pbFilter",
    "pfcfFilter","deFilter","daFilter","dyFilter","dpFilter","gmFilter",
    "omFilter","evFilter","rgFilter","egFilter","fgFilter","dgFilter",
    "sectorFilter","betaFilter"
  ];
  
  allSelects.forEach(id => {
      const el = document.getElementById(id);
      if(el) el.value = el.querySelector('option[value="0"]') ? "0" : "all";
  });

  // 3. åŸ·è¡Œç‰¹å®šç­–ç•¥æ•¸å€¼
  if (name === "buffett") {
      // å·´è²ç‰¹é¢¨æ ¼ï¼šæ”¾å¯¬ä¼°å€¼ï¼Œå …æŒå“è³ª
      setSelect("roeFilter",  "15");    // ROE â‰¥ 15% (å …æŒ)
      setSelect("roicFilter", "0.10");  // ROIC â‰¥ 10%
      // ä¿®æ­£ï¼šæ”¾å¯¬ç¾é‡‘æµè¦æ±‚ï¼Œé¿å…ç¯©ä¸åˆ°å¥½å…¬å¸
      setSelect("fcfFilter",  "0.02");  // FCF æ®–åˆ©ç‡ â‰¥ 2% (åŸæœ¬ 4% å¤ªåš´)
      setSelect("eyFilter",   "0.04");  // ç›ˆé¤˜æ®–åˆ©ç‡ â‰¥ 4% (PE < 25) (åŸæœ¬ 6% å¤ªåš´)
      setSelect("gmFilter",   "0.4");   // æ¯›åˆ©ç‡ â‰¥ 40%
      setSelect("omFilter",   "0.1");   // ç‡Ÿæ¥­åˆ©ç›Šç‡ â‰¥ 10%
      setSelect("dpFilter",   "0.6");   // é…æ¯ç‡ â‰¤ 60%
      setSelect("deFilter",   "0.5");   // D/E â‰¤ 0.5
      // Beta ä¸ä¸€å®šè¦é–æ­»ï¼Œå·´è²ç‰¹æœ‰æ™‚ä¹Ÿè²·æ³¢å‹•å¤§çš„è˜‹æœï¼Œä½†è¨­ 1.0 åä¿å®ˆä¹Ÿè¡Œ
      setSelect("betaFilter", "1.2");   // å»ºè­°ç¨å¾®æ”¾å¯¬åˆ° 1.2
    }

    if (name === "dividend") {
      // å¦‚æœæƒ³æŠ“æ›´å¤šç©©å¥çš„å¤§å‹è‚¡ï¼Œå»ºè­°æ®–åˆ©ç‡æ”¹ 0.03 (3%)
      setSelect("dyFilter",   "0.03");  
      setSelect("dpFilter",   "0.8");   
      setSelect("deFilter",   "1");     
      setSelect("betaFilter", "1.0");   
      setSelect("rgFilter",   "0.05");  
    }
    if (name === "growth") {
      // é«˜æˆé•·ç­–ç•¥
      setSelect("rgFilter",   "0.15");  // ç‡Ÿæ”¶å¹´å¢ç‡ â‰¥ 15%
      setSelect("egFilter",   "0.2");   // EPS å¹´å¢ç‡ â‰¥ 20%
      setSelect("gmFilter",   "0.5");   // æ¯›åˆ©ç‡ â‰¥ 50%
      setSelect("omFilter",   "0.1");   // ç‡Ÿæ¥­åˆ©ç›Šç‡ â‰¥ 10%
      setSelect("psFilter",   "10");    // P/S â‰¤ 10
    }



    if (name === "value") {
      // åƒ¹å€¼è‚¡ç­–ç•¥ï¼šé¿å…éåº¦åš´æ ¼
      setSelect("peFilter",   "15");    // PE â‰¤ 15
      setSelect("pbFilter",   "2");     // PB â‰¤ 2
      setSelect("pfcfFilter", "15");    // P/FCF â‰¤ 15
      // ä¿®æ­£ï¼šæ—¢ç„¶é™åˆ¶äº† PE <= 15ï¼Œé€™è£¡å°±ä¸ç”¨å†é– EY >= 8%ï¼Œé¿å…è¡çª
      setSelect("eyFilter",   "0");     
      setSelect("fcfFilter",  "0.04");  // FCF æ®–åˆ©ç‡ â‰¥ 4%
  }

    

    if (name === "lynch") {
      // 1. ä¼°å€¼ï¼šPEG å¿…é ˆä½æ–¼ 1.0 æ˜¯æ—å€çš„æ‹›ç‰Œ
      setSelect("pegFilter", "1"); 
      // 2. æˆé•·ï¼šç©©å¥æˆé•·ï¼Œä¸éœ€è¦çˆ†ç™¼æ€§ï¼Œä½†è¦åŠæ ¼
      setSelect("rgFilter",  "0.1");  // ç‡Ÿæ”¶æˆé•· >= 10%
      setSelect("egFilter",  "0.1");  // EPS æˆé•· >= 10%
      // 3. å“è³ªï¼šé«˜ ROE èˆ‡ è‰¯å¥½çš„ç²åˆ©èƒ½åŠ›
      setSelect("roeFilter", "15");   // ROE >= 15%
      setSelect("omFilter",  "0.1");  // ç‡Ÿæ¥­åˆ©ç›Šç‡ >= 10% (ç¢ºä¿ä¸æ˜¯é æ¥­å¤–)
      // 4. è²¡å‹™é«”è³ªï¼šæ—å€è¨å­è² å‚µ
      setSelect("deFilter",  "0.5");  // è² å‚µæ¬Šç›Šæ¯”æ›´åš´æ ¼ (<= 0.5)
      setSelect("crFilter",  "1.5");  // æµå‹•æ¯”ç‡ >= 1.5 (çŸ­æœŸå„Ÿå‚µèƒ½åŠ›)
      // 5. ç¾é‡‘æµï¼šä»–å¼·èª¿ç¾é‡‘æ˜¯çœŸå¯¦çš„
      setSelect("fcfFilter", "0.04"); // FCF æ®–åˆ©ç‡ >= 4%
    }



    if (name === "magic") {
      // é­”æ³•å…¬å¼ï¼šé«˜ ROIC + ä¾¿å®œ (EV/EBITDA)
      setSelect("roicFilter", "0.15"); // åŠ å¼·ï¼šROIC æ‹‰é«˜
      setSelect("evFilter",   "15");
      setSelect("roeFilter",  "15");
      // å»ºè­°ï¼šä¸é– PEï¼Œå°ˆæ³¨æ–¼ EV/EBITDA
    }



    if (name === "compounder") {
      // è¤‡åˆ©æˆé•·ï¼šé«˜å“è³ª + ç¾é‡‘æµæˆé•· (ä¸ä¸€å®šä¾¿å®œ)
      setSelect("roicFilter", "0.15"); // åŠ å¼·ï¼šæ•ˆç‡è¦é«˜
      setSelect("fcfFilter",  "0.02"); // æ”¾å¯¬ï¼šå¥½å…¬å¸æ®–åˆ©ç‡é€šå¸¸ä¸é«˜
      setSelect("fgFilter",   "0.10");
      setSelect("rgFilter",   "0.10");
      setSelect("gmFilter",   "0.3");  // æ”¾å¯¬ï¼šæ¶µè“‹æ›´å¤šç”¢æ¥­
    }



    if (name === "lowvol") {
      // ä½æ³¢å‹•ï¼šBeta ä½ + é…æ¯ç©©
      setSelect("betaFilter", "0.8");  // åŠ å¼·ï¼šBeta è¦å¤ ä½
      setSelect("deFilter",   "1");
      setSelect("roeFilter",  "10");
      setSelect("dyFilter",   "0.02"); // æ–°å¢ï¼šé˜²ç¦¦å‹é€šå¸¸æœ‰è‚¡æ¯
    }

  // 4. ç«‹å³æ¸²æŸ“
  applyFiltersAndRender();
  saveAllStates(); // <-- æ–°å¢é€™ä¸€è¡Œ
}

function resetFilters() {
    const filterIds = [
        "capFilter","roeFilter","roicFilter","fcfFilter","eyFilter","crFilter",
        "ndFilter","cccFilter","peFilter","pegFilter","psFilter","pbFilter",
        "pfcfFilter","deFilter","daFilter","dyFilter","dpFilter","gmFilter",
        "omFilter","evFilter","rgFilter","egFilter","fgFilter","dgFilter",
        "sectorFilter","betaFilter"
    ];

    filterIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.value = el.querySelector('option[value="0"]') ? "0" : "all";
            const group = el.closest('.filter-group');
            if (group) group.classList.remove("filter-active");
        }
    });

    document.querySelectorAll(".preset-btn").forEach(btn => btn.classList.remove("active"));
    sessionStorage.removeItem("activePreset");
    sessionStorage.removeItem("screener_state");

    applyFiltersAndRender();
    saveAllStates();
    
    // (é¸ç”¨) è®“æ‰€æœ‰æ‘ºç–Šå€å¡Šä¹Ÿä¸€èµ·æ”¶èµ·ä¾†ï¼š
    document.querySelectorAll('.filter-section').forEach(s => s.classList.remove("active"));
    
    alert("å·²æ¸…ç©ºæ‰€æœ‰ç¯©é¸æ¢ä»¶ï¼");
}

 async function loadData() {
  const pageSize = 1000;
  let from = 0;
  let all = [];

  while (true) {
    // é€™è£¡ä¹Ÿè¦è·Ÿè‘—æ”¹æˆ supabaseClient
      const { data, error } = await supabaseClient
      .from("core_metrics")
      .select(`
        symbol,
        market_cap,
        roa,
        roe,
        roic,
        fcf_yield,
        earnings_yield,
        current_ratio,
        net_debt_to_ebitda,
        ccc,
        pe,
        peg,
        ps,
        pb,
        p_fcf,
        debt_to_equity,
        debt_to_asset,
        dividendpayoutratio,
        dividendyield,
        dividendpershare,
        grossmargin,
        operatingmargin,
        evtoebitda,
        revenue_growth,
        eps_growth,
        fcf_growth,
        dividend_growth,
        beta,
        sector
      `)
      .range(from, from + pageSize - 1);

    if (error) {
      console.error(error);
      document.getElementById("summaryText").textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      return;
    }

    if (!data || data.length === 0) break;

    all = all.concat(data);

    // ä¸‹ä¸€é 
    if (data.length < pageSize) break;
    from += pageSize;
  }

  allRows = all;
  document.getElementById("summaryText").textContent = `å·²è¼‰å…¥ï¼š${allRows.length} æª”`;
  applyFiltersAndRender();
}


  function applyFiltersAndRender() {
    const capMode = document.getElementById("capFilter").value;
    const roeMin = Number(document.getElementById("roeFilter").value) / 100;
    const fcfMin = Number(document.getElementById("fcfFilter").value);
    const roicMin = Number(document.getElementById("roicFilter").value);
    const eyMin = Number(document.getElementById("eyFilter").value);   
    const crMin = Number(document.getElementById("crFilter").value);  
    const ndMode = document.getElementById("ndFilter").value;   
    const cccMode = document.getElementById("cccFilter").value;
    const peMode   = document.getElementById("peFilter").value;
    const pegMode  = document.getElementById("pegFilter").value;
    const psMode   = document.getElementById("psFilter").value;
    const pbMode   = document.getElementById("pbFilter").value;
    const pfcfMode = document.getElementById("pfcfFilter").value;
    const deMode   = document.getElementById("deFilter").value;
    const daMode   = document.getElementById("daFilter").value;
    const dyMin  = Number(document.getElementById("dyFilter").value);
    const dpMode = document.getElementById("dpFilter").value;

    const gmMin = Number(document.getElementById("gmFilter").value);
    const omMin = Number(document.getElementById("omFilter").value);
    const evMode = document.getElementById("evFilter").value;

    const rgMin = Number(document.getElementById("rgFilter").value);
    const egMin = Number(document.getElementById("egFilter").value);
    const fgMin = Number(document.getElementById("fgFilter").value);
    const dgMin = Number(document.getElementById("dgFilter").value);
    const sectorMode = document.getElementById("sectorFilter").value;
    const betaMode   = document.getElementById("betaFilter").value;

    let rows = allRows.filter(r => {
      // å¸‚å€¼
      if (capMode !== "all") {
        const cap = r.market_cap || 0;
        if (capMode === "mega" && !(cap >= 3e11)) return false;
        if (capMode === "large" && !(cap >= 1e11)) return false;
        if (capMode === "mid"   && !(cap >= 1e10 && cap < 1e11)) return false;
        if (capMode === "small" && !(cap <  1e10)) return false;
      }

      // ç²åˆ© & ç¾é‡‘æµ
      if (roeMin > 0 && (r.roe == null || r.roe < roeMin)) return false;
      if (fcfMin > 0 && (r.fcf_yield == null || r.fcf_yield < fcfMin)) return false;
      if (roicMin > 0 && (r.roic == null || r.roic < roicMin)) return false;
      if (eyMin > 0 && (r.earnings_yield == null || r.earnings_yield < eyMin)) return false;


      // æµå‹•æ¯”ç‡
      if (crMin > 0 && (r.current_ratio == null || r.current_ratio < crMin)) return false;

      // Net debt / EBITDA
      if (ndMode !== "all") {
        const ndMax = Number(ndMode);
        if (r.net_debt_to_ebitda == null || r.net_debt_to_ebitda > ndMax) return false;
      }

      // CCC
      if (cccMode === "neg" && !(r.ccc < 0)) return false;
      if (cccMode === "pos" && !(r.ccc >= 0)) return false;

      // ä¼°å€¼å€ç‡
      if (peMode !== "all") {
        const maxPE = Number(peMode);
        if (r.pe == null || r.pe > maxPE) return false;
      }
      if (pegMode !== "all") {
        const maxPEG = Number(pegMode);
        if (r.peg == null || r.peg > maxPEG) return false;
      }
      if (psMode !== "all") {
        const maxPS = Number(psMode);
        if (r.ps == null || r.ps > maxPS) return false;
      }
      if (pbMode !== "all") {
        const maxPB = Number(pbMode);
        if (r.pb == null || r.pb > maxPB) return false;
      }
      if (pfcfMode !== "all") {
        const maxPFCF = Number(pfcfMode);
        if (r.p_fcf == null || r.p_fcf > maxPFCF) return false;
      }

      // æ§“æ¡¿
      if (deMode !== "all") {
        const maxDE = Number(deMode);
        if (r.debt_to_equity == null || r.debt_to_equity > maxDE) return false;
      }
      if (daMode !== "all") {
        const maxDA = Number(daMode);
        if (r.debt_to_asset == null || r.debt_to_asset > maxDA) return false;
      }

      // è‚¡åˆ©æ¢ä»¶
      if (dyMin > 0 && (r.dividendyield == null || r.dividendyield < dyMin)) return false;
      if (dpMode !== "all") {
        const maxDP = Number(dpMode);
        if (r.dividendpayoutratio == null || r.dividendpayoutratio > maxDP) return false;
      }

      // ç²åˆ©çµæ§‹
      if (gmMin > 0 && (r.grossmargin == null || r.grossmargin < gmMin)) return false;
      if (omMin > 0 && (r.operatingmargin == null || r.operatingmargin < omMin)) return false;

      if (evMode !== "all") {
        const maxEV = Number(evMode);
        if (r.evtoebitda == null || r.evtoebitda > maxEV) return false;
      }

      // æˆé•·ç‡
      if (rgMin > 0 && (r.revenue_growth == null || r.revenue_growth < rgMin)) return false;
      if (egMin > 0 && (r.eps_growth == null || r.eps_growth < egMin)) return false;
      if (fgMin > 0 && (r.fcf_growth == null || r.fcf_growth < fgMin)) return false;
      if (dgMin > 0 && (r.dividend_growth == null || r.dividend_growth < dgMin)) return false;

      // ç”¢æ¥­
      if (sectorMode !== "all") {
        if (!r.sector || r.sector !== sectorMode) return false;
      }

      // Beta
      if (betaMode !== "all") {
        const maxBeta = Number(betaMode);
        if (r.beta == null || r.beta > maxBeta) return false;
      }

      return true;
    });

    // æ’åºï¼ˆæ•¸å­— / å­—ä¸²éƒ½æ”¯æ´ï¼‰
    rows.sort((a, b) => {
      const k = sortState.key;
      const va = a[k];
      const vb = b[k];

      if (va == null) return 1;
      if (vb == null) return -1;

      // å­—ä¸²ï¼šç”¨å­—æ¯æ’åº
      if (typeof va === "string" || typeof vb === "string") {
        return sortState.dir === "asc"
          ? String(va).localeCompare(String(vb))
          : String(vb).localeCompare(String(va));
      }
      // æ•¸å­—
      return sortState.dir === "asc" ? va - vb : vb - va;
    });
    // === ã€ä»¥ä¸‹æ˜¯æ ¸å¿ƒä¿®æ”¹å…§å®¹ã€‘ ===

    // A. å°‡ç¯©é¸æ’åºå®Œçš„ã€Œå®Œæ•´çµæœã€å­˜èµ·ä¾†
    currentFilteredRows = rows; 

    // B. åˆ¤æ–·è£ç½®ï¼Œé‡ç½®åˆå§‹é¡¯ç¤ºç­†æ•¸
    const isMobile = window.innerWidth <= 768;
    displayedCount = isMobile ? 50 : currentFilteredRows.length;

    // C. å‘¼å«æ¸²æŸ“å‡½å¼ (ç¾åœ¨ä¸éœ€è¦å‚³åƒæ•¸ï¼Œè®“ renderTable ç›´æ¥è®€å– currentFilteredRows)
    renderTable();

  
  }

  function renderTable() {
      const tbody = document.getElementById("tableBody");
      const summary = document.getElementById("summaryText");
      const loadMoreContainer = document.getElementById("loadMoreContainer");
      const currentCountText = document.getElementById("currentCountText");

      // 1. æ¸…ç©ºèˆŠçš„å…§å®¹
      tbody.innerHTML = "";
      
      // 2. æ›´æ–°ç¸½ç­†æ•¸æç¤º
      summary.textContent = `ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ï¼š${currentFilteredRows.length} æª”`;

      // 3. ã€é—œéµä¿®æ”¹ã€‘ä½¿ç”¨ slice åªå–å‡ºç›®å‰è¦é¡¯ç¤ºçš„ç­†æ•¸ (ä¾‹å¦‚ 0 åˆ° 50)
      const slice = currentFilteredRows.slice(0, displayedCount);

      // 4. åªå¾ªç’° slice å‡ºä¾†çš„è³‡æ–™
      slice.forEach(r => {
        const cccClass = r.ccc != null && r.ccc < 0 ? "pill-pos" : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <a href="analysis.html?symbol=${r.symbol}" class="symbol-link">
              <span class="badge">${r.symbol}</span>
            </a>
          </td>
          <td>${formatCap(r.market_cap)}</td>
          <td>${r.sector || "-"}</td>
          <td>${r.beta != null ? r.beta.toFixed(2) : "-"}</td>
          <td>${pct(r.roa)}</td>
          <td>${pct(r.roe)}</td>
          <td>${pct(r.roic)}</td>
          <td>${pct(r.fcf_yield)}</td>
          <td>${pct(r.earnings_yield)}</td>
          <td>${r.current_ratio != null ? r.current_ratio.toFixed(2) : "-"}</td>
          <td>${r.net_debt_to_ebitda != null ? r.net_debt_to_ebitda.toFixed(2) : "-"}</td>
          <td class="${cccClass}">${r.ccc != null ? r.ccc.toFixed(2) : "-"}</td>
          <td>${r.pe != null ? r.pe.toFixed(2) : "-"}</td>
          <td>${r.peg != null ? r.peg.toFixed(2) : "-"}</td>
          <td>${r.ps != null ? r.ps.toFixed(2) : "-"}</td>
          <td>${r.pb != null ? r.pb.toFixed(2) : "-"}</td>
          <td>${r.p_fcf != null ? r.p_fcf.toFixed(2) : "-"}</td>
          <td>${r.debt_to_equity != null ? r.debt_to_equity.toFixed(2) : "-"}</td>
          <td>${r.debt_to_asset != null ? r.debt_to_asset.toFixed(2) : "-"}</td>
          <td>${pct(r.dividendyield)}</td>
          <td>${r.dividendpershare != null ? r.dividendpershare.toFixed(2) : "-"}</td>
          <td>${pct(r.dividendpayoutratio)}</td>
          <td>${pct(r.grossmargin)}</td>
          <td>${pct(r.operatingmargin)}</td>
          <td>${r.evtoebitda != null ? r.evtoebitda.toFixed(2) : "-"}</td>
          <td>${pct(r.revenue_growth)}</td>
          <td>${pct(r.eps_growth)}</td>
          <td>${pct(r.fcf_growth)}</td>
          <td>${pct(r.dividend_growth)}</td>
        `;
        tbody.appendChild(tr);
      });

      // 5. ã€é—œéµä¿®æ”¹ã€‘åˆ¤æ–·æ˜¯å¦é‚„æœ‰æ›´å¤šè³‡æ–™å¯ä»¥è¼‰å…¥
      if (currentFilteredRows.length > displayedCount) {
          loadMoreContainer.style.display = "block";
          currentCountText.textContent = slice.length;
      } else {
          loadMoreContainer.style.display = "none";
      }
  }

  // ç¯©é¸å™¨ change äº‹ä»¶
  // é€™è£¡å®šç¾©æ‰€æœ‰é¸å–®çš„ ID
  const filterIds = [
    "capFilter","roeFilter","roicFilter","fcfFilter","eyFilter","crFilter",
    "ndFilter","cccFilter","peFilter","pegFilter","psFilter","pbFilter",
    "pfcfFilter","deFilter","daFilter","dyFilter","dpFilter","gmFilter",
    "omFilter","evFilter","rgFilter","egFilter","fgFilter","dgFilter",
    "sectorFilter","betaFilter"
  ];
  
  // æ‰¹æ¬¡ç¶å®šï¼šæ‰‹å‹•æ›´æ”¹é¸å–®æ™‚ã€Œéæ¿¾ã€ï¼‹ã€Œå­˜æª”å¾®èª¿çµæœã€
  filterIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("change", () => {
        applyFiltersAndRender();
        saveAllStates(); // <-- é€™æ˜¯è¨˜ä½ã€Œæ‰‹å‹•å¾®èª¿ã€çš„é—œéµï¼
      });
    }
  });

  // ä¸€éµç­–ç•¥æŒ‰éˆ•äº‹ä»¶
  document.querySelectorAll(".preset-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const name = btn.dataset.preset;  // buffett / dividend / growth / value
      // ğŸš© é—œéµä¿®æ­£ï¼šå¦‚æœé€™å€‹æŒ‰éˆ•æ²’æœ‰ data-preset å±¬æ€§ï¼ˆåƒæ˜¯é¡¯ç¤ºæ›´å¤šæŒ‰éˆ•ï¼‰ï¼Œå°±ä¸è¦åŸ·è¡Œç­–ç•¥
      if (!name) return;
      applyPreset(name);
    });
  });

  // æ’åºäº‹ä»¶
  document.querySelectorAll("th[data-sort]").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.dataset.sort;
      if (sortState.key === key) {
        sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
      } else {
        sortState.key = key;
        sortState.dir = "desc";
      }
      applyFiltersAndRender();
      saveAllStates();
    });
  });

  // â˜…â˜…â˜… æ–°å¢ï¼šæœå°‹è·³è½‰åŠŸèƒ½ â˜…â˜…â˜…
  function goToSnapshot() {
    const input = document.getElementById("stockInput");
    const symbol = input.value.trim().toUpperCase(); // å»é™¤ç©ºç™½ä¸¦è½‰å¤§å¯«

    if (!symbol) {
      alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼");
      return;
    }

    // è·³è½‰åˆ° analysis.html ä¸¦å¸¶ä¸Š symbol åƒæ•¸
    window.location.href = `analysis.html?symbol=${symbol}`;
  }

  // ç¶å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
  document.getElementById("btnGoSnapshot").addEventListener("click", goToSnapshot);
  document.getElementById("btnClearAll").addEventListener("click", resetFilters);

  // ç¶å®š Enter éµäº‹ä»¶ (è®“ä½¿ç”¨è€…æŒ‰ Enter ä¹Ÿèƒ½æœå°‹)
  document.getElementById("stockInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      goToSnapshot();
    }
  });

  // === æ–°å¢ï¼šæ§åˆ¶æ‘ºç–Šé¸å–®çš„å‡½å¼ ===
  function toggleSection(header) {
  // æ‰¾åˆ° header çš„çˆ¶å±¤ (filter-section)
    const section = header.parentElement;
  
  // åˆ‡æ› active class
  // å¦‚æœåŸæœ¬æœ‰é—œé–‰ï¼Œç¾åœ¨æ‰“é–‹ï¼›åŸæœ¬æ‰“é–‹ï¼Œç¾åœ¨é—œé–‰
  section.classList.toggle("active");
  
  // (é¸ç”¨) å¦‚æœå¸Œæœ›ä¸€æ¬¡åªé–‹ä¸€å€‹ï¼Œå¯ä»¥å…ˆæŠŠå…¶ä»–çš„é—œæ‰ï¼š
  /*
  document.querySelectorAll('.filter-section').forEach(s => {
    if (s !== section) s.classList.remove('active');
  });
  */
}

// === æ–°å¢ï¼šé é¢è¼‰å…¥æ™‚æ¢å¾©ä¸Šæ¬¡é»é¸çš„é¢¨æ ¼ ===
// ä¿®æ”¹é é¢è¿”å›æ™‚çš„é‚è¼¯
window.addEventListener('pageshow', (event) => {
    // å„ªå…ˆå˜—è©¦é‚„åŸå®Œæ•´å­˜æª”
    const hasRestored = restoreAllStates();
    if (hasRestored) {
        applyFiltersAndRender();
    }
});

// ä¿®æ”¹è³‡æ–™è¼‰å…¥å‡½å¼çš„çµå°¾
async function loadData() {
  const pageSize = 1000;
  let from = 0;
  let all = []; // é—œéµï¼šå®šç¾© all è®Šæ•¸

  while (true) {
    const { data, error } = await supabaseClient
      .from("core_metrics")
      .select(`
        symbol, market_cap, roa, roe, roic, fcf_yield, earnings_yield,
        current_ratio, net_debt_to_ebitda, ccc, pe, peg, ps, pb, p_fcf,
        debt_to_equity, debt_to_asset, dividendpayoutratio, dividendyield,
        dividendpershare, grossmargin, operatingmargin, evtoebitda,
        revenue_growth, eps_growth, fcf_growth, dividend_growth, beta, sector
      `)
      .range(from, from + pageSize - 1);

    if (error) {
      console.error(error);
      document.getElementById("summaryText").textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      return;
    }

    if (!data || data.length === 0) break;
    all = all.concat(data);

    if (data.length < pageSize) break;
    from += pageSize;
  }

  allRows = all;
  document.getElementById("summaryText").textContent = `å·²è¼‰å…¥ï¼š${allRows.length} æª”`;
  
  // æ ¸å¿ƒï¼šè¼‰å…¥è³‡æ–™å¾Œï¼Œå…ˆé‚„åŸä¸Šæ¬¡å„²å­˜çš„é¸å–®ç‹€æ…‹ï¼Œå†é€²è¡Œç¯©é¸èˆ‡æ¸²æŸ“
  restoreAllStates(); 
  applyFiltersAndRender();
}

// åœ¨ script å€å¡Šæœ€å¾Œé¢åŠ å…¥
  document.getElementById("btnLoadMore").addEventListener("click", (e) => {
      e.preventDefault(); // é›™é‡ä¿éšªï¼šé˜²æ­¢ä»»ä½•é è¨­æäº¤è¡Œç‚º
      displayedCount += 50; 
      renderTable(); // ğŸš© é—œéµï¼šåªé‡æ–°ç•«åœ–ï¼Œä¸é‡æ–°è·‘ applyFiltersAndRender
  });

  loadData();
  </script>
</body>
</html>
