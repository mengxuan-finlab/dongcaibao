<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>懂才抱｜財報快照</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0f1b33;
      --stroke: rgba(255,255,255,.12);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --good:#22c55e;
      --mid:#60a5fa;
      --bad:#f59e0b;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Microsoft JhengHei",sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(99,102,241,.25), transparent 60%),
        radial-gradient(700px 400px at 80% 30%, rgba(34,197,94,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 28px 18px 64px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    .title{
      font-size: 28px;
      font-weight: 800;
      letter-spacing:.2px;
      margin:0;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size: 14px;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      text-decoration:none;
      font-size: 13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      backdrop-filter: blur(10px);
      transition: transform .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      margin-top: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(12px);
    }
    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
      gap: 10px;
    }
    .cardTitle{
      font-weight: 800;
      font-size: 14px;
      letter-spacing:.2px;
      color: #ffffff;
      opacity:.95;
      margin:0;
    }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      white-space:nowrap;
    }

    .scoreWrap{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
    }
    .ring{
      width: 120px;
      height: 120px;
      position: relative;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background:
        conic-gradient(var(--ringColor) calc(var(--p)*1%), rgba(255,255,255,.12) 0);
      box-shadow: inset 0 0 0 10px rgba(0,0,0,.15);
    }
    .ring::after{
      content:"";
      position:absolute;
      inset: 10px;
      border-radius: 999px;
      background: rgba(15,27,51,.9);
      border: 1px solid rgba(255,255,255,.10);
    }
    .ringInner{
      position:relative;
      z-index:1;
      text-align:center;
      line-height:1.1;
    }
    .scoreNum{
      font-size: 28px;
      font-weight: 900;
    }
    .scoreDen{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .grade{
      font-weight: 800;
      font-size: 14px;
      margin-top: 6px;
      color: var(--ringColor);
    }

    .bars{
      flex: 1;
      min-width: 260px;
    }
    .barRow{
      margin: 10px 0;
    }
    .barTop{
      display:flex;
      justify-content:space-between;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .bar{
      height: 10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar > div{
      height:100%;
      width: var(--w);
      background: linear-gradient(90deg, rgba(255,255,255,.25), var(--ringColor));
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 640px){
      .kpiGrid{ grid-template-columns: repeat(2, 1fr); }
    }
    .kpi{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .kLabel{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kVal{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .kHint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .note{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.6;
    }

    .state{
      padding: 14px 16px;
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 14px;
      color: var(--muted);
      background: rgba(255,255,255,.04);
    }

    .insight{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .insightTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .insightTitle h4{
      margin:0;
      font-size: 13px;
      font-weight: 800;
      letter-spacing:.2px;
      color:#fff;
      opacity:.92;
    }
    .insightTitle .tag{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    .insight ul{
      margin: 0;
      padding-left: 18px;
      color: var(--text);
      opacity: .92;
      font-size: 13px;
      line-height: 1.7;
    }
    .insight li{ margin: 6px 0; }

    /* Charts */
    .chartGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .chartBox{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .chartTitle{
      font-size: 13px;
      font-weight: 800;
      margin: 0 0 8px;
      color: rgba(255,255,255,.92);
    }
    .chartCanvasWrap{
      height: 220px;
    }

    /* Health Check（自成一格，放在趨勢下面） */
    .healthCard{
      padding: 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .healthHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .healthHeader h3{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .healthGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .healthGrid{ grid-template-columns: 1fr; }
    }
    .healthBox{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .healthBoxTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .healthBoxTitle b{
      font-size: 13px;
      opacity: .95;
    }

    /* Health 專用 pill（避免污染全域 .pill） */
    .hpill{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space:nowrap;
    }
    .hpill.good{ border-color: rgba(39,200,122,.35); color: rgba(195,255,223,.92); }
    .hpill.mid { border-color: rgba(255,203, 74,.35); color: rgba(255,239,200,.92); }
    .hpill.bad { border-color: rgba(255, 96, 96,.35); color: rgba(255,205,205,.92); }

    .healthList{
      margin: 0;
      padding-left: 18px;
      color: var(--text);
      opacity: .92;
      font-size: 13px;
      line-height: 1.7;
    }
    .healthList li{ margin: 6px 0; }
    .healthNote{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      opacity: .92;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title" id="title">載入中...</h1>
        <div class="subtitle" id="subTitle">懂才抱 · 財報快照（Snapshot）</div>
      </div>

      <div class="actions">
        <a class="btn" href="core_screener.html">← 回選股器</a>
        <a class="btn" id="tvLink" href="#" target="_blank" rel="noopener">TradingView</a>
        <a class="btn" id="yfLink" href="#" target="_blank" rel="noopener">Yahoo</a>
      </div>
    </div>

    <div id="snapshot" class="state">正在載入資料…</div>
    <div id="trends" style="margin-top:16px;"></div>
    <div id="health" style="margin-top:16px;"></div>
  </div>

<script>
const SUPABASE_URL = "https://ojeirmqxborwxhuwuems.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_wur9F2qRW0NFyZpijPub2A__IsGlpgZ";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(window.location.search);
const symbol = (params.get("symbol") || "").toUpperCase();

// ===== FMP (Income / Cash Flow) =====
const FMP_API_KEY = "PHTJpjhhPVzIdzjMEP84WKq5JiNRYxA6";
let _revChart = null;
let _epsChart = null;
let _fcfChart = null;

async function fetchIncomeStatementFY(sym) {
  const url = `https://financialmodelingprep.com/stable/income-statement?symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(FMP_API_KEY)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`FMP income HTTP ${res.status}`);
  const json = await res.json();
  if (!Array.isArray(json)) return [];

  return json
    .filter(r => (String(r.period || "").toUpperCase() === "FY") || (r.calendarYear && !r.period))
    .map(r => ({
      year: Number(r.fiscalYear || r.calendarYear || (r.date ? String(r.date).slice(0,4) : NaN)),
      revenue: Number(r.revenue),
      eps: Number((r.eps ?? r.epsDiluted)),
    }))
    .filter(r => Number.isFinite(r.year))
    .sort((a,b) => a.year - b.year);
}

async function fetchCashFlowFY(sym) {
  const url = `https://financialmodelingprep.com/stable/cash-flow-statement?symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(FMP_API_KEY)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`FMP cashflow HTTP ${res.status}`);
  const json = await res.json();
  if (!Array.isArray(json)) return [];

  return json
    .filter(r => String(r.period || "").toUpperCase() === "FY")
    .map(r => ({
      year: Number(r.fiscalYear || (r.date ? String(r.date).slice(0,4) : NaN)),
      fcf: Number(r.freeCashFlow),
    }))
    .filter(r => Number.isFinite(r.year))
    .sort((a,b) => a.year - b.year);
}

function destroyCharts(){
  if (_revChart) { _revChart.destroy(); _revChart = null; }
  if (_epsChart) { _epsChart.destroy(); _epsChart = null; }
  if (_fcfChart) { _fcfChart.destroy(); _fcfChart = null; }
}

function renderLineChart(canvas, labels, series, title, ySuffix="", decimals=1){
  const ctx = canvas.getContext("2d");
  return new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: title,
        data: series,
        tension: 0.25,
        pointRadius: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (c) => `${Number(c.parsed.y).toFixed(decimals)}${ySuffix}`
          }
        }
      },
      scales: {
        x: { ticks: { maxRotation: 0 } },
        y: {
          ticks: {
            callback: (v) => Number(v).toFixed(decimals) // 左邊刻度小數位
          }
        }
      }
    }
  });
}

async function loadQuickTrends(sym){
  const el = document.getElementById("trends");
  if (!el) return;

  el.innerHTML = `
    <div class="card">
      <div class="cardHeader">
        <h3 class="cardTitle">財務趨勢（Quick Trends）</h3>
        <span class="pill">FMP · Income & Cash Flow</span>
      </div>

      <div id="trendState" class="note">載入中…</div>

      <div class="chartGrid">
        <div class="chartBox">
          <div class="chartTitle">營收（億 USD）</div>
          <div class="chartCanvasWrap"><canvas id="revChart"></canvas></div>
        </div>

        <div class="chartBox">
          <div class="chartTitle">EPS（USD）</div>
          <div class="chartCanvasWrap"><canvas id="epsChart"></canvas></div>
        </div>

        <div class="chartBox">
          <div class="chartTitle">自由現金流 FCF（億 USD）</div>
          <div class="chartCanvasWrap"><canvas id="fcfChart"></canvas></div>
        </div>
      </div>

      <div class="note">資料來源：Financial Modeling Prep（年度 FY）。</div>
    </div>
  `;

  try{
    destroyCharts();

    const [fy, fcfFY] = await Promise.all([
      fetchIncomeStatementFY(sym),
      fetchCashFlowFY(sym),
    ]);

    const state = document.getElementById("trendState");

    if (!fy.length){
      state.textContent = "暫時抓不到趨勢資料（可能 API 無資料或被限制）。";
      return;
    }

    const last = fy.slice(-8);
    const labels = last.map(x => String(x.year));
    const revenueB = last.map(x => Number.isFinite(x.revenue) ? +(x.revenue / 1e9).toFixed(1) : null);
    const eps = last.map(x => Number.isFinite(x.eps) ? +x.eps.toFixed(2) : null);

    const fcfMap = new Map((fcfFY || []).map(r => [r.year, r.fcf]));
    const fcfB = last.map(x => {
      const v = fcfMap.get(x.year);
      return Number.isFinite(v) ? +(v / 1e9).toFixed(1) : null;
    });

    state.textContent = "";

    _revChart = renderLineChart(document.getElementById("revChart"), labels, revenueB, "Revenue", " 億", 1);
    _epsChart = renderLineChart(document.getElementById("epsChart"), labels, eps, "EPS", "", 2);
    _fcfChart = renderLineChart(document.getElementById("fcfChart"), labels, fcfB, "Free Cash Flow", " 億", 1);

  } catch(e){
    const state = document.getElementById("trendState");
    if (state) state.textContent = `趨勢載入失敗：${e.message}`;
  }
}

// --------- formatting ----------
function fmtPct(x, digits=1){
  if (x == null || Number.isNaN(x)) return "—";
  return (x*100).toFixed(digits) + "%";
}
function fmtNum(x, digits=1){
  if (x == null || Number.isNaN(x)) return "—";
  return Number(x).toFixed(digits);
}
function fmtCap(x){
  if (x == null || Number.isNaN(x)) return "—";
  const n = Number(x);
  if (n >= 1e12) return (n/1e12).toFixed(2) + " 兆";
  if (n >= 1e9)  return (n/1e9).toFixed(1) + " 億";
  if (n >= 1e6)  return (n/1e6).toFixed(1) + " 百萬";
  return n.toLocaleString();
}
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

// --------- scoring ----------
function calculateScore(d) {
  let quality = 0, growth = 0, valuation = 0;

  // 品質（40）
  if (d.roe >= 0.2) quality += 15;
  else if (d.roe >= 0.1) quality += 10;
  else quality += 5;

  if (d.roic >= 0.15) quality += 15;
  else if (d.roic >= 0.08) quality += 10;
  else quality += 5;

  if (d.fcf_yield >= 0.04) quality += 10;
  else if (d.fcf_yield >= 0.02) quality += 5;

  // 成長（30）
  if (d.revenue_growth >= 0.15) growth += 15;
  else if (d.revenue_growth >= 0.05) growth += 10;
  else growth += 5;

  if (d.eps_growth >= 0.15) growth += 15;
  else if (d.eps_growth >= 0.05) growth += 10;
  else growth += 5;

  // 估值（30）
  if (d.pe != null && d.pe <= 20) valuation += 15;
  else if (d.pe != null && d.pe <= 30) valuation += 10;
  else valuation += 5;

  if (d.fcf_yield >= 0.04) valuation += 15;
  else if (d.fcf_yield >= 0.02) valuation += 10;
  else valuation += 5;

  const total = quality + growth + valuation;

  let grade = "普通";
  if (total >= 80) grade = "優質";
  else if (total >= 65) grade = "良好";

  let ringColor = getComputedStyle(document.documentElement).getPropertyValue('--mid').trim();
  if (total >= 80) ringColor = getComputedStyle(document.documentElement).getPropertyValue('--good').trim();
  else if (total < 65) ringColor = getComputedStyle(document.documentElement).getPropertyValue('--bad').trim();

  return { total, quality, growth, valuation, grade, ringColor };
}

function buildInsight(d, s) {
  const lines = [];

  const rev = d.revenue_growth;
  const eps = d.eps_growth;
  if (rev == null || eps == null) {
    lines.push("成長：部分成長指標缺值，建議再確認營收與 EPS 的最新趨勢。");
  } else if (rev >= 0.15 && eps >= 0.15) {
    lines.push("成長：營收與 EPS 皆維持高速成長，支撐成長評分。");
  } else if (rev < 0.05 && eps < 0.05) {
    lines.push("成長：營收與 EPS 成長偏弱（或趨緩），使成長評分受壓。");
  } else {
    lines.push("成長：成長動能分歧（營收與 EPS 一強一弱），建議留意可持續性。");
  }

  const roe = d.roe;
  const roic = d.roic;
  if (roe == null || roic == null) {
    lines.push("品質：ROE/ROIC 指標缺值，無法完整判斷資本效率。");
  } else if (roe >= 0.2 && roic >= 0.15) {
    lines.push("品質：ROE 與 ROIC 皆偏高，代表資本效率與獲利品質良好。");
  } else if (roe < 0.1 || roic < 0.08) {
    lines.push("品質：ROE 或 ROIC 偏低，顯示資本效率較保守，品質評分偏弱。");
  } else {
    lines.push("品質：資本效率落在中段水準，屬於穩定但不極強的品質結構。");
  }

  const pe = d.pe;
  const fcfy = d.fcf_yield;
  if (pe == null || fcfy == null) {
    lines.push("估值：估值指標缺值，建議補齊 PE 與 FCF 殖利率再評估。");
  } else if (pe <= 20 && fcfy >= 0.04) {
    lines.push("估值：PE 偏合理且 FCF 殖利率較佳，估值面相對友善。");
  } else if (pe > 30 && fcfy < 0.02) {
    lines.push("估值：PE 偏高且 FCF 殖利率偏低，估值評分容易被拉低。");
  } else {
    lines.push("估值：估值落在中性區間，建議搭配成長性一起衡量是否合理。");
  }

  return lines.slice(0, 3);
}

function yn(ok){ return ok ? "✅" : "❌"; }

function buildHealthChecks(d){
  const rev = Number(d.revenue_growth);
  const eps = Number(d.eps_growth);
  const roic = Number(d.roic);
  const roe = Number(d.roe);
  const beta = Number(d.beta);
  const pe = Number(d.pe);
  const peg = Number(d.peg);
  const fcfy = Number(d.fcf_yield);

  const growthChecks = [
    { label: "營收 YoY ≥ 10%", ok: Number.isFinite(rev) && rev >= 0.10 },
    { label: "EPS YoY ≥ 10%", ok: Number.isFinite(eps) && eps >= 0.10 },
    { label: "ROIC ≥ 12%", ok: Number.isFinite(roic) && roic >= 0.12 },
    { label: "PEG ≤ 2.5（有資料時）", ok: !Number.isFinite(peg) ? true : (peg > 0 && peg <= 2.5) },
  ];

  const incomeChecks = [
    { label: "FCF 殖利率 ≥ 3%", ok: Number.isFinite(fcfy) && fcfy >= 0.03 },
    { label: "ROE ≥ 12%（穩定獲利能力）", ok: Number.isFinite(roe) && roe >= 0.12 },
    { label: "營收 YoY ≥ 3%（不萎縮）", ok: Number.isFinite(rev) && rev >= 0.03 },
    { label: "β ≤ 1.2（波動較低）", ok: Number.isFinite(beta) && beta <= 1.2 },
  ];

  const valueChecks = [
    { label: "PE ≤ 20（有資料時）", ok: !Number.isFinite(pe) ? true : pe > 0 && pe <= 20 },
    { label: "PEG ≤ 1.5（有資料時）", ok: !Number.isFinite(peg) ? true : (peg > 0 && peg <= 1.5) },
    { label: "FCF 殖利率 ≥ 4%", ok: Number.isFinite(fcfy) && fcfy >= 0.04 },
    { label: "ROIC ≥ 10%（便宜但也要好）", ok: Number.isFinite(roic) && roic >= 0.10 },
  ];

  const riskChecks = [
    { label: "ROE > 0", ok: Number.isFinite(roe) && roe > 0 },
    { label: "ROIC > 0", ok: Number.isFinite(roic) && roic > 0 },
    { label: "FCF 殖利率 > 0", ok: Number.isFinite(fcfy) && fcfy > 0 },
    { label: "PEG 不為負（有資料時）", ok: !Number.isFinite(peg) ? true : peg > 0 },
  ];

  function pack(title, checks){
    const pass = checks.filter(c => c.ok).length;
    const total = checks.length;
    const ratio = pass / total;
    const level = ratio >= 0.75 ? "good" : ratio >= 0.5 ? "mid" : "bad";
    const label = ratio >= 0.75 ? "偏符合" : ratio >= 0.5 ? "中性" : "偏不符合";
    return { title, checks, pass, total, level, label };
  }

  return [
    pack("成長型投資適配度", growthChecks),
    pack("定存型投資適配度", incomeChecks),
    pack("價值型投資適配度", valueChecks),
    pack("排除地雷股", riskChecks),
  ];
}

function renderHealthSection(d){
  const host = document.getElementById("health");
  if (!host) return;

  const blocks = buildHealthChecks(d);

  host.innerHTML = `
    <div class="healthCard">
      <div class="healthHeader">
        <h3>投資風格適配度分析</h3>
      </div>

      <div class="healthGrid">
        ${blocks.map(b => `
          <div class="healthBox">
            <div class="healthBoxTitle">
              <b>${b.title}</b>
              <span class="hpill ${b.level}">${b.pass}/${b.total} · ${b.label}</span>
            </div>
            <ul class="healthList">
              ${b.checks.map(c => `<li>${yn(c.ok)} ${c.label}</li>`).join("")}
            </ul>
          </div>
        `).join("")}
      </div>

      <div class="healthNote">
        註：此為規則式快篩，用於快速比較，不構成投資建議。
      </div>
    </div>
  `;
}

async function loadSnapshot() {
  if (!symbol) {
    document.getElementById("title").innerText = "懂才抱｜財報快照";
    document.getElementById("snapshot").className = "state";
    document.getElementById("snapshot").innerText = "網址缺少 symbol，例如：analysis.html?symbol=AAPL";
    return;
  }

  document.getElementById("tvLink").href = `https://www.tradingview.com/symbols/NASDAQ-${symbol}/`;
  document.getElementById("yfLink").href = `https://finance.yahoo.com/quote/${symbol}`;

  const { data, error } = await supabase
    .from("core_metrics")
    .select("*")
    .eq("symbol", symbol)
    .single();

  if (error || !data) {
    document.getElementById("title").innerText = `${symbol}｜財報快照`;
    document.getElementById("snapshot").className = "state";
    document.getElementById("snapshot").innerText = "找不到資料（可能尚未寫入 core_metrics）。";
    document.getElementById("trends").innerHTML = "";
    document.getElementById("health").innerHTML = "";
    return;
  }

  const s = calculateScore(data);
  const insight = buildInsight(data, s);

  document.getElementById("title").innerText = `${data.symbol}｜財報快照`;

  const scoreP = clamp(s.total, 0, 100);
  const qP = clamp(Math.round((s.quality/40)*100), 0, 100);
  const gP = clamp(Math.round((s.growth/30)*100), 0, 100);
  const vP = clamp(Math.round((s.valuation/30)*100), 0, 100);

  document.getElementById("snapshot").className = "";
  document.getElementById("snapshot").innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <h3 class="cardTitle">快照評分</h3>
          <span class="pill">Snapshot Score</span>
        </div>

        <div class="scoreWrap" style="--ringColor:${s.ringColor};">
          <div class="ring" style="--p:${scoreP}; --ringColor:${s.ringColor};">
            <div class="ringInner">
              <div class="scoreNum">${s.total}</div>
              <div class="scoreDen">/ 100</div>
              <div class="grade">${s.grade}</div>
            </div>
          </div>

          <div class="bars">
            <div class="barRow">
              <div class="barTop"><span>品質</span><span>${s.quality}/40</span></div>
              <div class="bar"><div style="--w:${qP}%; --ringColor:${s.ringColor};"></div></div>
            </div>
            <div class="barRow">
              <div class="barTop"><span>成長</span><span>${s.growth}/30</span></div>
              <div class="bar"><div style="--w:${gP}%; --ringColor:${s.ringColor};"></div></div>
            </div>
            <div class="barRow">
              <div class="barTop"><span>估值</span><span>${s.valuation}/30</span></div>
              <div class="bar"><div style="--w:${vP}%; --ringColor:${s.ringColor};"></div></div>
            </div>

            <div class="note">
              評分用於快速比較公司獲利品質、成長性與估值水準；僅供參考，不構成投資建議。
            </div>

            <div class="insight">
              <div class="insightTitle">
                <h4>AI 快速解讀</h4>
                <span class="tag">Snapshot Insight</span>
              </div>
              <ul>
                <li>${insight[0]}</li>
                <li>${insight[1]}</li>
                <li>${insight[2]}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <h3 class="cardTitle">公司快照</h3>
          <span class="pill">core_metrics</span>
        </div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="kLabel">市值</div>
            <div class="kVal">${fmtCap(data.market_cap)}</div>
            <div class="kHint">Market Cap</div>
          </div>

          <div class="kpi">
            <div class="kLabel">PE</div>
            <div class="kVal">${data.pe == null ? "—" : fmtNum(data.pe, 1)}</div>
            <div class="kHint">Price / Earnings</div>
          </div>

          <div class="kpi">
            <div class="kLabel">PEG</div>
            <div class="kVal">${data.peg == null ? "—" : fmtNum(data.peg, 2)}</div>
            <div class="kHint">PEG Ratio</div>
          </div>

          <div class="kpi">
            <div class="kLabel">ROE</div>
            <div class="kVal">${fmtPct(data.roe, 1)}</div>
            <div class="kHint">Equity Return</div>
          </div>

          <div class="kpi">
            <div class="kLabel">ROIC</div>
            <div class="kVal">${fmtPct(data.roic, 1)}</div>
            <div class="kHint">Invested Capital</div>
          </div>

          <div class="kpi">
            <div class="kLabel">FCF 殖利率</div>
            <div class="kVal">${fmtPct(data.fcf_yield, 1)}</div>
            <div class="kHint">Free Cash Flow</div>
          </div>

          <div class="kpi">
            <div class="kLabel">營收 YoY</div>
            <div class="kVal">${fmtPct(data.revenue_growth, 1)}</div>
            <div class="kHint">Revenue Growth</div>
          </div>

          <div class="kpi">
            <div class="kLabel">EPS YoY</div>
            <div class="kVal">${fmtPct(data.eps_growth, 1)}</div>
            <div class="kHint">EPS Growth</div>
          </div>

          <div class="kpi">
            <div class="kLabel">β</div>
            <div class="kVal">${data.beta == null ? "—" : fmtNum(data.beta, 2)}</div>
            <div class="kHint">Volatility</div>
          </div>
        </div>

        <div class="note">
          若對於公司資訊及財報相關內容有更詳細需求，可使用懂才抱後續服務
        </div>
      </div>
    </div>
  `;

  // 先畫健診（在趨勢下面，自成一格）
  renderHealthSection(data);

  // 再載入趨勢圖（只呼叫一次）
  requestAnimationFrame(() => loadQuickTrends(symbol));
}

loadSnapshot();
</script>
</body>
</html>
