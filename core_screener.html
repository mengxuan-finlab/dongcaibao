<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ‡‚æ‰æŠ±ï¼æ ¸å¿ƒæŒ‡æ¨™é¸è‚¡å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="css/core_screener.css" />
</head>
<body>
  <div class="container">
    <h1>æ‡‚æ‰æŠ±æ ¸å¿ƒæŒ‡æ¨™é¸è‚¡å™¨</h1>
    <p class="subtitle">è³‡æ–™ä¾†è‡ª core_metricsï¼šå¸‚å€¼ã€ROAã€ROEã€FCF æ®–åˆ©ç‡ã€ç¾é‡‘è½‰æ›é€±æœŸç­‰é—œéµè²¡å‹™æŒ‡æ¨™ã€‚</p>

    <div class="filters">
      <div class="filter-group">
        <label for="capFilter">å¸‚å€¼ç¯©é¸</label>
        <select id="capFilter">
          <option value="all">å…¨éƒ¨å¸‚å€¼</option>
          <option value="mega">è¶…å¤§å‹ â‰¥ 3000 å„„ç¾å…ƒ</option>
          <option value="large">å¤§å‹ â‰¥ 1000 å„„ç¾å…ƒ</option>
          <option value="mid">ä¸­å‹ â‰¥ 100 å„„ç¾å…ƒ</option>
          <option value="small">å°å‹ &lt; 100 å„„ç¾å…ƒ</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="roeFilter">ROEï¼ˆè‚¡æ±æ¬Šç›Šå ±é…¬ç‡ï¼‰â‰¥</label>
        <select id="roeFilter">
          <option value="0">ä¸é™</option>
          <option value="10">10%</option>
          <option value="15">15%</option>
          <option value="20">20%</option>
          <option value="30">30%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="roicFilter">ROICï¼ˆæŠ•å…¥è³‡æœ¬å ±é…¬ç‡ï¼‰â‰¥</label>
        <select id="roicFilter">
          <option value="0">ä¸é™</option>
          <option value="0.10">10%</option>
          <option value="0.15">15%</option>
          <option value="0.20">20%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="fcfFilter">FCF æ®–åˆ©ç‡ â‰¥</label>
        <select id="fcfFilter">
          <option value="0">ä¸é™</option>
          <option value="0.02">2%</option>
          <option value="0.04">4%</option>
          <option value="0.06">6%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="eyFilter">ç›ˆé¤˜æ®–åˆ©ç‡ï¼ˆEarnings Yieldï¼‰â‰¥</label>
        <select id="eyFilter">
          <option value="0">ä¸é™</option>
          <option value="0.04">4%</option>
          <option value="0.06">6%</option>
          <option value="0.08">8%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="crFilter">æµå‹•æ¯”ç‡ â‰¥</label>
        <select id="crFilter">
          <option value="0">ä¸é™</option>
          <option value="1">1.0</option>
          <option value="1.5">1.5</option>
          <option value="2">2.0</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="ndFilter">æ·¨è² å‚µ / EBITDA â‰¤</label>
        <select id="ndFilter">
          <option value="all">ä¸é™</option>
          <option value="4">4 å€</option>
          <option value="3">3 å€</option>
          <option value="2">2 å€</option>
          <option value="1">1 å€</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="cccFilter">ç¾é‡‘è½‰æ›é€±æœŸï¼ˆCCCï¼‰</label>
        <select id="cccFilter">
          <option value="all">ä¸é™</option>
          <option value="neg">å°æ–¼ 0ï¼ˆç¾é‡‘é€±æœŸå„ªå‹¢ï¼‰</option>
          <option value="pos">å¤§æ–¼ç­‰æ–¼ 0</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="peFilter">æœ¬ç›Šæ¯”ï¼ˆPEï¼‰â‰¤</label>
        <select id="peFilter">
          <option value="all">ä¸é™</option>
          <option value="40">40</option>
          <option value="30">30</option>
          <option value="20">20</option>
          <option value="15">15</option>
          <option value="10">10</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="pegFilter">æœ¬ç›Šæˆé•·æ¯”ï¼ˆPEGï¼‰â‰¤</label>
        <select id="pegFilter">
          <option value="all">ä¸é™</option>
          <option value="2">2.0</option>
          <option value="1.5">1.5</option>
          <option value="1">1.0</option>
          <option value="0.5">0.5</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="psFilter">è‚¡åƒ¹ç‡Ÿæ”¶æ¯”ï¼ˆP/Sï¼‰â‰¤</label>
        <select id="psFilter">
          <option value="all">ä¸é™</option>
          <option value="10">10</option>
          <option value="5">5</option>
          <option value="3">3</option>
          <option value="2">2</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="pbFilter">è‚¡åƒ¹æ·¨å€¼æ¯”ï¼ˆP/Bï¼‰â‰¤</label>
        <select id="pbFilter">
          <option value="all">ä¸é™</option>
          <option value="10">10</option>
          <option value="5">5</option>
          <option value="3">3</option>
          <option value="2">2</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="pfcfFilter">è‚¡åƒ¹ / è‡ªç”±ç¾é‡‘æµï¼ˆP/FCFï¼‰â‰¤</label>
        <select id="pfcfFilter">
          <option value="all">ä¸é™</option>
          <option value="40">40</option>
          <option value="30">30</option>
          <option value="20">20</option>
          <option value="15">15</option>
          <option value="10">10</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="deFilter">è² å‚µ / è‚¡æ±æ¬Šç›Šï¼ˆD/Eï¼‰â‰¤</label>
        <select id="deFilter">
          <option value="all">ä¸é™</option>
          <option value="2">2.0</option>
          <option value="1.5">1.5</option>
          <option value="1">1.0</option>
          <option value="0.5">0.5</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="daFilter">è² å‚µ / è³‡ç”¢ï¼ˆD/Aï¼‰â‰¤</label>
        <select id="daFilter">
          <option value="all">ä¸é™</option>
          <option value="0.8">0.8</option>
          <option value="0.6">0.6</option>
          <option value="0.4">0.4</option>
          <option value="0.2">0.2</option>
        </select>
      </div>

      <!-- â˜… è‚¡åˆ©ç›¸é—œ -->
      <div class="filter-group">
        <label for="dyFilter">è‚¡æ¯æ®–åˆ©ç‡ â‰¥</label>
        <select id="dyFilter">
          <option value="0">ä¸é™</option>
          <option value="0.02">2%</option>
          <option value="0.03">3%</option>
          <option value="0.04">4%</option>
          <option value="0.05">5%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="dpFilter">é…æ¯ç‡ï¼ˆPayout Ratioï¼‰â‰¤</label>
        <select id="dpFilter">
          <option value="all">ä¸é™</option>
          <option value="0.8">80%</option>
          <option value="0.6">60%</option>
          <option value="0.4">40%</option>
        </select>
      </div>

      <!-- â˜… ç²åˆ©çµæ§‹ -->
      <div class="filter-group">
        <label for="gmFilter">æ¯›åˆ©ç‡ï¼ˆGross Marginï¼‰â‰¥</label>
        <select id="gmFilter">
          <option value="0">ä¸é™</option>
          <option value="0.3">30%</option>
          <option value="0.4">40%</option>
          <option value="0.5">50%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="omFilter">ç‡Ÿæ¥­åˆ©ç›Šç‡ï¼ˆOperating Marginï¼‰â‰¥</label>
        <select id="omFilter">
          <option value="0">ä¸é™</option>
          <option value="0.1">10%</option>
          <option value="0.15">15%</option>
          <option value="0.2">20%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="evFilter">EV / EBITDA â‰¤</label>
        <select id="evFilter">
          <option value="all">ä¸é™</option>
          <option value="20">20</option>
          <option value="15">15</option>
          <option value="10">10</option>
        </select>
      </div>

      <!-- â˜… æˆé•·ç‡ -->
      <div class="filter-group">
        <label for="rgFilter">ç‡Ÿæ”¶å¹´å¢ç‡ï¼ˆRev YoYï¼‰â‰¥</label>
        <select id="rgFilter">
          <option value="0">ä¸é™</option>
          <option value="0.05">5%</option>
          <option value="0.1">10%</option>
          <option value="0.15">15%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="egFilter">EPS å¹´å¢ç‡ â‰¥</label>
        <select id="egFilter">
          <option value="0">ä¸é™</option>
          <option value="0.05">5%</option>
          <option value="0.1">10%</option>
          <option value="0.2">20%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="fgFilter">FCF å¹´å¢ç‡ â‰¥</label>
        <select id="fgFilter">
          <option value="0">ä¸é™</option>
          <option value="0.05">5%</option>
          <option value="0.1">10%</option>
          <option value="0.2">20%</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="dgFilter">è‚¡æ¯å¹´å¢ç‡ â‰¥</label>
        <select id="dgFilter">
          <option value="0">ä¸é™</option>
          <option value="0.03">3%</option>
          <option value="0.05">5%</option>
          <option value="0.1">10%</option>
        </select>
      </div>

      <!-- ç”¢æ¥­ -->
      <div class="filter-group">
        <label for="sectorFilter">ç”¢æ¥­ï¼ˆSectorï¼‰</label>
        <select id="sectorFilter">
          <option value="all">å…¨éƒ¨ç”¢æ¥­</option>
          <option value="Basic Materials">åŸºç¤åŸç‰©æ–™ï¼ˆBasic Materialsï¼‰</option>
          <option value="Communication Services">é€šè¨Šæœå‹™ï¼ˆCommunication Servicesï¼‰</option>
          <option value="Consumer Cyclical">æ™¯æ°£å¾ªç’°æ¶ˆè²»ï¼ˆConsumer Cyclicalï¼‰</option>
          <option value="Consumer Defensive">é˜²ç¦¦æ€§æ¶ˆè²»ï¼ˆConsumer Defensiveï¼‰</option>
          <option value="Energy">èƒ½æºï¼ˆEnergyï¼‰</option>
          <option value="Financial Services">é‡‘èæœå‹™ï¼ˆFinancial Servicesï¼‰</option>
          <option value="Healthcare">é†«ç™‚ä¿å¥ï¼ˆHealthcareï¼‰</option>
          <option value="Industrials">å·¥æ¥­ï¼ˆIndustrialsï¼‰</option>
          <option value="Real Estate">ä¸å‹•ç”¢ï¼ˆReal Estateï¼‰</option>
          <option value="Technology">ç§‘æŠ€ï¼ˆTechnologyï¼‰</option>
          <option value="Utilities">å…¬ç”¨äº‹æ¥­ï¼ˆUtilitiesï¼‰</option>
        </select>
      </div>

      <!-- Beta -->
      <div class="filter-group">
        <label for="betaFilter">Î²ï¼ˆå¸‚å ´æ³¢å‹•ï¼‰â‰¤</label>
        <select id="betaFilter">
          <option value="all">ä¸é™</option>
          <option value="1.5">1.5</option>
          <option value="1.2">1.2</option>
          <option value="1.0">1.0</option>
          <option value="0.8">0.8</option>
        </select>
      </div>

      <!-- ä¸€éµç­–ç•¥æŒ‰éˆ•åˆ— -->
      <div class="preset-bar">
        <button class="preset-btn" data-preset="buffett">ä¸€éµå¥—ç”¨ï¼šå·´è²ç‰¹é¢¨æ ¼</button>
        <button class="preset-btn" data-preset="dividend">ä¸€éµå¥—ç”¨ï¼šé«˜è‚¡æ¯ç­–ç•¥</button>
        <button class="preset-btn" data-preset="growth">ä¸€éµå¥—ç”¨ï¼šé«˜æˆé•·ç­–ç•¥</button>
        <button class="preset-btn" data-preset="value">ä¸€éµå¥—ç”¨ï¼šåƒ¹å€¼è‚¡ç­–ç•¥</button>
        <button class="preset-btn" data-preset="lynch">ä¸€éµå¥—ç”¨ï¼šå½¼å¾—æ—å€ PEG</button>
        <button class="preset-btn" data-preset="magic">ä¸€éµå¥—ç”¨ï¼šé­”æ³•å…¬å¼</button>
        <button class="preset-btn" data-preset="compounder">ä¸€éµå¥—ç”¨ï¼šè¤‡åˆ©æˆé•·è‚¡</button>
        <button class="preset-btn" data-preset="lowvol">ä¸€éµå¥—ç”¨ï¼šä½æ³¢å‹•ç­–ç•¥</button>
      </div>
    </div>

    <div class="summary" id="summaryText">è¼‰å…¥ä¸­...</div>

    <table>
      <thead>
        <tr>
          <th data-sort="symbol">è‚¡ç¥¨ä»£è™Ÿ</th>
          <th data-sort="market_cap">å¸‚å€¼</th>
          <th data-sort="sector">ç”¢æ¥­</th>
          <th data-sort="beta">Î²</th>
          <th data-sort="roa">ROAï¼ˆè³‡ç”¢å ±é…¬ç‡ï¼‰</th>
          <th data-sort="roe">ROEï¼ˆè‚¡æ±æ¬Šç›Šå ±é…¬ç‡ï¼‰</th>
          <th data-sort="roic">ROICï¼ˆæŠ•å…¥è³‡æœ¬å ±é…¬ç‡ï¼‰</th>
          <th data-sort="fcf_yield">FCF æ®–åˆ©ç‡</th>
          <th data-sort="earnings_yield">ç›ˆé¤˜æ®–åˆ©ç‡</th>
          <th data-sort="current_ratio">æµå‹•æ¯”ç‡</th>
          <th data-sort="net_debt_to_ebitda">æ·¨è² å‚µ / EBITDA</th>
          <th data-sort="ccc">ç¾é‡‘è½‰æ›é€±æœŸï¼ˆCCCï¼‰</th>
          <th data-sort="pe">æœ¬ç›Šæ¯”ï¼ˆPEï¼‰</th>
          <th data-sort="peg">æœ¬ç›Šæˆé•·æ¯”ï¼ˆPEGï¼‰</th>
          <th data-sort="ps">è‚¡åƒ¹ç‡Ÿæ”¶æ¯”ï¼ˆP/Sï¼‰</th>
          <th data-sort="pb">è‚¡åƒ¹æ·¨å€¼æ¯”ï¼ˆP/Bï¼‰</th>
          <th data-sort="p_fcf">è‚¡åƒ¹ / FCF</th>
          <th data-sort="debt_to_equity">è² å‚µ / è‚¡æ±æ¬Šç›Š</th>
          <th data-sort="debt_to_asset">è² å‚µ / è³‡ç”¢</th>
          <th data-sort="dividendyield">è‚¡æ¯æ®–åˆ©ç‡</th>
          <th data-sort="dividendpershare">æ¯è‚¡è‚¡æ¯</th>
          <th data-sort="dividendpayoutratio">é…æ¯ç‡</th>
          <th data-sort="grossmargin">æ¯›åˆ©ç‡</th>
          <th data-sort="operatingmargin">ç‡Ÿæ¥­åˆ©ç›Šç‡</th>
          <th data-sort="evtoebitda">EV / EBITDA</th>
          <th data-sort="revenue_growth">ç‡Ÿæ”¶å¹´å¢ç‡</th>
          <th data-sort="eps_growth">EPS å¹´å¢ç‡</th>
          <th data-sort="fcf_growth">FCF å¹´å¢ç‡</th>
          <th data-sort="dividend_growth">è‚¡æ¯å¹´å¢ç‡</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
  // === Supabase è¨­å®š ===
  const SUPABASE_URL = "https://ojeirmqxborwxhuwuems.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_wur9F2qRW0NFyZpijPub2A__IsGlpgZ";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let allRows = [];
  let sortState = { key: "market_cap", dir: "desc" };

  function formatCap(x) {
    if (x == null) return "-";
    if (x >= 1e12) return (x / 1e12).toFixed(2) + " å…†";
    if (x >= 1e9)  return (x / 1e9 ).toFixed(2) + " å„„";
    if (x >= 1e6)  return (x / 1e6 ).toFixed(2) + " ç™¾è¬";
    return x.toLocaleString();
  }
  function pct(x) {
    if (x == null) return "-";
    return (x * 100).toFixed(2) + "%";
  }

  // ğŸ”¹ å°å·¥å…·ï¼šè¨­å®šæŸå€‹ select çš„å€¼
  function setSelect(id, value) {
    const el = document.getElementById(id);
    if (el && value !== undefined) {
      el.value = value;
    }
  }

  // ğŸ”¹ ä¸€éµç­–ç•¥ï¼šä¾åç¨±èª¿æ•´æ‰€æœ‰ç¯©é¸å™¨
  function applyPreset(name) {
    // å…ˆé‡ç½®æˆã€Œä¸é™ / å…¨éƒ¨ã€
    setSelect("capFilter",   "all");
    setSelect("roeFilter",   "0");
    setSelect("roicFilter",  "0");
    setSelect("fcfFilter",   "0");
    setSelect("eyFilter",    "0");
    setSelect("crFilter",    "0");
    setSelect("ndFilter",    "all");
    setSelect("cccFilter",   "all");
    setSelect("peFilter",    "all");
    setSelect("pegFilter",   "all");
    setSelect("psFilter",    "all");
    setSelect("pbFilter",    "all");
    setSelect("pfcfFilter",  "all");
    setSelect("deFilter",    "all");
    setSelect("daFilter",    "all");
    setSelect("dyFilter",    "0");
    setSelect("dpFilter",    "all");
    setSelect("gmFilter",    "0");
    setSelect("omFilter",    "0");
    setSelect("evFilter",    "all");
    setSelect("rgFilter",    "0");
    setSelect("egFilter",    "0");
    setSelect("fgFilter",    "0");
    setSelect("dgFilter",    "0");
    setSelect("sectorFilter","all");
    setSelect("betaFilter",  "all");

    if (name === "buffett") {
      // å·´è²ç‰¹é¢¨æ ¼ï¼ˆé«˜å“è³ªï¼‹ç©©å¥ï¼‰
      setSelect("roeFilter",  "15");    // ROE â‰¥ 15%
      setSelect("roicFilter", "0.10");  // ROIC â‰¥ 10%
      setSelect("fcfFilter",  "0.04");  // FCF æ®–åˆ©ç‡ â‰¥ 4%
      setSelect("eyFilter",   "0.06");  // ç›ˆé¤˜æ®–åˆ©ç‡ â‰¥ 6%
      setSelect("gmFilter",   "0.4");   // æ¯›åˆ©ç‡ â‰¥ 40%
      setSelect("omFilter",   "0.1");   // ç‡Ÿæ¥­åˆ©ç›Šç‡ â‰¥ 10%
      setSelect("dpFilter",   "0.6");   // é…æ¯ç‡ â‰¤ 60%
      setSelect("deFilter",   "0.5");   // D/E â‰¤ 0.5
      setSelect("betaFilter", "1.0");   // Î² â‰¤ 1
    }

    if (name === "dividend") {
      // é«˜è‚¡æ¯ç­–ç•¥
      setSelect("dyFilter",   "0.04");  // è‚¡æ¯æ®–åˆ©ç‡ â‰¥ 4%
      setSelect("dpFilter",   "0.8");   // é…æ¯ç‡ â‰¤ 80%
      setSelect("deFilter",   "1");     // D/E â‰¤ 1
      setSelect("betaFilter", "1.0");   // Î² â‰¤ 1
      setSelect("rgFilter",   "0.05");  // ç‡Ÿæ”¶å¹´å¢ç‡ â‰¥ 5%
    }

    if (name === "growth") {
      // é«˜æˆé•·ç­–ç•¥
      setSelect("rgFilter",   "0.15");  // ç‡Ÿæ”¶å¹´å¢ç‡ â‰¥ 15%
      setSelect("egFilter",   "0.2");   // EPS å¹´å¢ç‡ â‰¥ 20%
      setSelect("gmFilter",   "0.5");   // æ¯›åˆ©ç‡ â‰¥ 50%
      setSelect("omFilter",   "0.1");   // ç‡Ÿæ¥­åˆ©ç›Šç‡ â‰¥ 10%
      setSelect("psFilter",   "10");    // P/S â‰¤ 10
    }

    if (name === "value") {
      // åƒ¹å€¼è‚¡ç­–ç•¥
      setSelect("peFilter",   "15");    // æœ¬ç›Šæ¯” â‰¤ 15
      setSelect("pbFilter",   "2");     // P/B â‰¤ 2
      setSelect("pfcfFilter", "15");    // P/FCF â‰¤ 15
      setSelect("eyFilter",   "0.08");  // ç›ˆé¤˜æ®–åˆ©ç‡ â‰¥ 8%
      setSelect("fcfFilter",  "0.04");  // FCF æ®–åˆ©ç‡ â‰¥ 4%
    }
    
    if (name === "lynch") {
      // å½¼å¾—æ—å€ï¼šPEG ä¾¿å®œæˆé•·è‚¡
      setSelect("pegFilter", "1.5");     // PEG â‰¤ 1.5
      setSelect("rgFilter", "0.10");     // ç‡Ÿæ”¶ YoY â‰¥ 10%
      setSelect("egFilter", "0.10");     // EPS YoY â‰¥ 10%
      setSelect("roeFilter", "15");      // ROE â‰¥ 15%
    }

    if (name === "magic") {
      // é­”æ³•å…¬å¼ï¼šROIC é«˜ + å…¬å¸ä¾¿å®œ
      setSelect("roicFilter", "0.10");     // ROIC â‰¥ 10%
      setSelect("evFilter", "15");         // EV/EBITDA â‰¤ 15
      setSelect("peFilter", "20");         // PE â‰¤ 20ï¼ˆå¯é¸ï¼‰
    }

    if (name === "compounder") {
      // è¤‡åˆ©æˆé•·è‚¡ï¼ˆè‡ªç”±ç¾é‡‘æµå¼·ï¼‹è­·åŸæ²³ï¼‰
      setSelect("roicFilter", "0.10");
      setSelect("fcfFilter", "0.04");       // FCF Yield â‰¥ 4%
      setSelect("fgFilter", "0.10");        // FCF YoY â‰¥ 10%
      setSelect("rgFilter", "0.10");        // Rev YoY â‰¥ 10%
      setSelect("gmFilter", "0.50");        // æ¯›åˆ© â‰¥ 50%
    }

    if (name === "lowvol") {
      // ä½æ³¢å‹•ç­–ç•¥ï¼šä½ Beta + é«˜å“è³ª
      setSelect("betaFilter", "1.0");       // Beta â‰¤ 1
      setSelect("deFilter", "1");           // D/E â‰¤ 1
      setSelect("roeFilter", "10");         // ROE â‰¥ 10%
    }

    applyFiltersAndRender();
  }

  async function loadData() {
    const { data, error } = await supabase
      .from("core_metrics")
      .select(`
        symbol,
        market_cap,
        roa,
        roe,
        roic,
        fcf_yield,
        earnings_yield,
        current_ratio,
        net_debt_to_ebitda,
        ccc,
        pe,
        peg,
        ps,
        pb,
        p_fcf,
        debt_to_equity,
        debt_to_asset,
        dividendpayoutratio,   
        dividendyield,          
        dividendpershare,       
        grossmargin,            
        operatingmargin,        
        evtoebitda,            
        revenue_growth,       
        eps_growth,             
        fcf_growth,             
        dividend_growth,
        beta,
        sector         
      `);

    if (error) {
      console.error(error);
      document.getElementById("summaryText").textContent = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      return;
    }

    allRows = data;
    applyFiltersAndRender();
  }

  function applyFiltersAndRender() {
    const capMode = document.getElementById("capFilter").value;
    const roeMin = Number(document.getElementById("roeFilter").value) / 100;
    const fcfMin = Number(document.getElementById("fcfFilter").value);
    const roicMin = Number(document.getElementById("roicFilter").value);
    const eyMin = Number(document.getElementById("eyFilter").value);   
    const crMin = Number(document.getElementById("crFilter").value);  
    const ndMode = document.getElementById("ndFilter").value;   
    const cccMode = document.getElementById("cccFilter").value;
    const peMode   = document.getElementById("peFilter").value;
    const pegMode  = document.getElementById("pegFilter").value;
    const psMode   = document.getElementById("psFilter").value;
    const pbMode   = document.getElementById("pbFilter").value;
    const pfcfMode = document.getElementById("pfcfFilter").value;
    const deMode   = document.getElementById("deFilter").value;
    const daMode   = document.getElementById("daFilter").value;
    const dyMin  = Number(document.getElementById("dyFilter").value);
    const dpMode = document.getElementById("dpFilter").value;

    const gmMin = Number(document.getElementById("gmFilter").value);
    const omMin = Number(document.getElementById("omFilter").value);
    const evMode = document.getElementById("evFilter").value;

    const rgMin = Number(document.getElementById("rgFilter").value);
    const egMin = Number(document.getElementById("egFilter").value);
    const fgMin = Number(document.getElementById("fgFilter").value);
    const dgMin = Number(document.getElementById("dgFilter").value);
    const sectorMode = document.getElementById("sectorFilter").value;
    const betaMode   = document.getElementById("betaFilter").value;

    let rows = allRows.filter(r => {
      // å¸‚å€¼
      if (capMode !== "all") {
        const cap = r.market_cap || 0;
        if (capMode === "mega" && !(cap >= 3e11)) return false;
        if (capMode === "large" && !(cap >= 1e11)) return false;
        if (capMode === "mid"   && !(cap >= 1e10 && cap < 1e11)) return false;
        if (capMode === "small" && !(cap <  1e10)) return false;
      }

      // ç²åˆ© & ç¾é‡‘æµ
      if (r.roe == null || r.roe < roeMin) return false;
      if (r.fcf_yield == null || r.fcf_yield < fcfMin) return false;
      if (r.roic == null || r.roic < roicMin) return false;
      if (r.earnings_yield == null || r.earnings_yield < eyMin) return false;

      // æµå‹•æ¯”ç‡
      if (crMin > 0 && (r.current_ratio == null || r.current_ratio < crMin)) return false;

      // Net debt / EBITDA
      if (ndMode !== "all") {
        const ndMax = Number(ndMode);
        if (r.net_debt_to_ebitda == null || r.net_debt_to_ebitda > ndMax) return false;
      }

      // CCC
      if (cccMode === "neg" && !(r.ccc < 0)) return false;
      if (cccMode === "pos" && !(r.ccc >= 0)) return false;

      // ä¼°å€¼å€ç‡
      if (peMode !== "all") {
        const maxPE = Number(peMode);
        if (r.pe == null || r.pe > maxPE) return false;
      }
      if (pegMode !== "all") {
        const maxPEG = Number(pegMode);
        if (r.peg == null || r.peg > maxPEG) return false;
      }
      if (psMode !== "all") {
        const maxPS = Number(psMode);
        if (r.ps == null || r.ps > maxPS) return false;
      }
      if (pbMode !== "all") {
        const maxPB = Number(pbMode);
        if (r.pb == null || r.pb > maxPB) return false;
      }
      if (pfcfMode !== "all") {
        const maxPFCF = Number(pfcfMode);
        if (r.p_fcf == null || r.p_fcf > maxPFCF) return false;
      }

      // æ§“æ¡¿
      if (deMode !== "all") {
        const maxDE = Number(deMode);
        if (r.debt_to_equity == null || r.debt_to_equity > maxDE) return false;
      }
      if (daMode !== "all") {
        const maxDA = Number(daMode);
        if (r.debt_to_asset == null || r.debt_to_asset > maxDA) return false;
      }

      // è‚¡åˆ©æ¢ä»¶
      if (dyMin > 0 && (r.dividendyield == null || r.dividendyield < dyMin)) return false;
      if (dpMode !== "all") {
        const maxDP = Number(dpMode);
        if (r.dividendpayoutratio == null || r.dividendpayoutratio > maxDP) return false;
      }

      // ç²åˆ©çµæ§‹
      if (gmMin > 0 && (r.grossmargin == null || r.grossmargin < gmMin)) return false;
      if (omMin > 0 && (r.operatingmargin == null || r.operatingmargin < omMin)) return false;

      if (evMode !== "all") {
        const maxEV = Number(evMode);
        if (r.evtoebitda == null || r.evtoebitda > maxEV) return false;
      }

      // æˆé•·ç‡
      if (rgMin > 0 && (r.revenue_growth == null || r.revenue_growth < rgMin)) return false;
      if (egMin > 0 && (r.eps_growth == null || r.eps_growth < egMin)) return false;
      if (fgMin > 0 && (r.fcf_growth == null || r.fcf_growth < fgMin)) return false;
      if (dgMin > 0 && (r.dividend_growth == null || r.dividend_growth < dgMin)) return false;

      // ç”¢æ¥­
      if (sectorMode !== "all") {
        if (!r.sector || r.sector !== sectorMode) return false;
      }

      // Beta
      if (betaMode !== "all") {
        const maxBeta = Number(betaMode);
        if (r.beta == null || r.beta > maxBeta) return false;
      }

      return true;
    });

    // æ’åºï¼ˆæ•¸å­— / å­—ä¸²éƒ½æ”¯æ´ï¼‰
    rows.sort((a, b) => {
      const k = sortState.key;
      const va = a[k];
      const vb = b[k];

      if (va == null) return 1;
      if (vb == null) return -1;

      // å­—ä¸²ï¼šç”¨å­—æ¯æ’åº
      if (typeof va === "string" || typeof vb === "string") {
        return sortState.dir === "asc"
          ? String(va).localeCompare(String(vb))
          : String(vb).localeCompare(String(va));
      }
      // æ•¸å­—
      return sortState.dir === "asc" ? va - vb : vb - va;
    });

    renderTable(rows);
  }

  function renderTable(rows) {
    const tbody = document.getElementById("tableBody");
    const summary = document.getElementById("summaryText");
    tbody.innerHTML = "";
    summary.textContent = `ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ï¼š${rows.length} æª”`;

    rows.forEach(r => {
      const cccClass = r.ccc != null && r.ccc < 0 ? "pill-pos" : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="badge">${r.symbol}</span></td>
        <td>${formatCap(r.market_cap)}</td>
        <td>${r.sector || "-"}</td>
        <td>${r.beta != null ? r.beta.toFixed(2) : "-"}</td>
        <td>${pct(r.roa)}</td>
        <td>${pct(r.roe)}</td>
        <td>${pct(r.roic)}</td>
        <td>${pct(r.fcf_yield)}</td>
        <td>${pct(r.earnings_yield)}</td>
        <td>${r.current_ratio != null ? r.current_ratio.toFixed(2) : "-"}</td>
        <td>${r.net_debt_to_ebitda != null ? r.net_debt_to_ebitda.toFixed(2) : "-"}</td>
        <td class="${cccClass}">${r.ccc != null ? r.ccc.toFixed(2) : "-"}</td>
        <td>${r.pe != null ? r.pe.toFixed(2) : "-"}</td>
        <td>${r.peg != null ? r.peg.toFixed(2) : "-"}</td>
        <td>${r.ps != null ? r.ps.toFixed(2) : "-"}</td>
        <td>${r.pb != null ? r.pb.toFixed(2) : "-"}</td>
        <td>${r.p_fcf != null ? r.p_fcf.toFixed(2) : "-"}</td>
        <td>${r.debt_to_equity != null ? r.debt_to_equity.toFixed(2) : "-"}</td>
        <td>${r.debt_to_asset != null ? r.debt_to_asset.toFixed(2) : "-"}</td>
        <td>${pct(r.dividendyield)}</td>
        <td>${r.dividendpershare != null ? r.dividendpershare.toFixed(2) : "-"}</td>
        <td>${pct(r.dividendpayoutratio)}</td>
        <td>${pct(r.grossmargin)}</td>
        <td>${pct(r.operatingmargin)}</td>
        <td>${r.evtoebitda != null ? r.evtoebitda.toFixed(2) : "-"}</td>
        <td>${pct(r.revenue_growth)}</td>
        <td>${pct(r.eps_growth)}</td>
        <td>${pct(r.fcf_growth)}</td>
        <td>${pct(r.dividend_growth)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ç¯©é¸å™¨ change äº‹ä»¶
  document.getElementById("capFilter").addEventListener("change", applyFiltersAndRender); 
  document.getElementById("roeFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("roicFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("fcfFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("eyFilter").addEventListener("change", applyFiltersAndRender);   
  document.getElementById("crFilter").addEventListener("change", applyFiltersAndRender);   
  document.getElementById("ndFilter").addEventListener("change", applyFiltersAndRender); 
  document.getElementById("cccFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("peFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("pegFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("psFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("pbFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("pfcfFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("deFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("daFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("dyFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("dpFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("gmFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("omFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("evFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("rgFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("egFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("fgFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("dgFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("sectorFilter").addEventListener("change", applyFiltersAndRender);
  document.getElementById("betaFilter").addEventListener("change", applyFiltersAndRender);

  // ä¸€éµç­–ç•¥æŒ‰éˆ•äº‹ä»¶
  document.querySelectorAll(".preset-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const name = btn.dataset.preset;  // buffett / dividend / growth / value
      applyPreset(name);
    });
  });

  // æ’åºäº‹ä»¶
  document.querySelectorAll("th[data-sort]").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.dataset.sort;
      if (sortState.key === key) {
        sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
      } else {
        sortState.key = key;
        sortState.dir = "desc";
      }
      applyFiltersAndRender();
    });
  });

  loadData();
  </script>
</body>
</html>
